<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>관리자 페이지 - 출퇴근 관리</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
    .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .section h3 { margin-top: 0; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; font-weight: bold; color: #495057; }
    tr:hover { background-color: #f9f9f9; }
    button { padding: 8px 16px; margin: 4px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff; transition: all 0.2s; }
    button:hover { background: #f0f0f0; transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.primary { background: #007bff; color: white; border-color: #007bff; }
    button.primary:hover { background: #0056b3; }
    button.danger { background: #dc3545; color: white; border-color: #dc3545; }
    button.danger:hover { background: #c82333; }
    input, select { padding: 8px; margin: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
    .login-form { max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .error { color: #dc3545; margin: 10px 0; padding: 8px; background: #f8d7da; border-radius: 4px; }
    .success { color: #28a745; margin: 10px 0; padding: 8px; background: #d4edda; border-radius: 4px; }
    .hidden { display: none; }
    .info-box { padding: 12px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px; margin: 10px 0; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .pending-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: #fef2f2;
      color: #b91c1c;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.6);
      z-index: 2000;
      padding: 24px;
    }
    .modal-overlay.show { display: flex; }
    .modal-dialog {
      background: #ffffff;
      border-radius: 14px;
      padding: 24px 28px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
      text-align: center;
    }
    .modal-dialog h3 { margin: 0 0 12px; font-size: 20px; color: #0f172a; }
    .modal-dialog p { margin: 0; font-size: 14px; color: #475569; line-height: 1.5; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    .modal-actions button {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .modal-actions button.secondary {
      background: #e2e8f0;
      color: #1f2937;
    }
    .loading { opacity: 0.6; pointer-events: none; }
    .photo-preview {
      width: auto;
      height: 32px;
      max-width: 100%;
      border: 1px solid #d4d4d8;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
      display: block;
      object-fit: contain;
      object-position: center;
      background: #fff;
      image-orientation: from-image;
    }
    .photo-preview:hover { transform: scale(1.05); }
    .truncate { max-width: 120px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
    .name-cell { max-width: 120px; }
    .emp-inline-name { display: none; margin-left: 8px; font-weight: 500; color: #333; }
    .section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
    .section-header h3 { margin: 0; }
    .section-header-actions { display: flex; gap: 8px; font-size: 13px; }
    .section-header-actions button { padding: 6px 10px; font-size: 12px; white-space: nowrap; min-width: 120px; cursor: pointer; }
    .records-table table { width: 100%; border-collapse: collapse; }
    .records-table td { vertical-align: middle; }
    .record-filter-row { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; min-width: 160px; }
    .filters { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start; margin-top: 12px; }
    .filters .filter-group { min-width: 150px; display: flex; flex-direction: column; gap: 10px; }
    .filters .filter-id { flex: 1 1 220px; }
    .filters .filter-period { flex: 1 1 320px; }
    .filters .filter-label { font-weight: 700; color: #1e293b; font-size: 13px; letter-spacing: -0.01em; }
    .input-card { background: linear-gradient(145deg, #ecfeff, #cffafe); border: 1px solid #bae6fd; border-radius: 16px; padding: 16px 18px; box-shadow: 0 10px 22px rgba(14, 165, 233, 0.12); display: flex; flex-direction: column; gap: 10px; min-height: 118px; justify-content: center; }
    .input-card input[type="text"] { width: 100%; padding: 11px 12px; border: 1px solid #bae6fd; border-radius: 10px; background: rgba(255,255,255,0.92); font-size: 14px; font-weight: 500; color: #0f172a; transition: border 0.12s ease, box-shadow 0.12s ease; }
    .input-card input[type="text"]::placeholder { color: #94a3b8; }
    .input-card input[type="text"]:focus { outline: none; border-color: #0284c7; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.2); background: #fff; }
    .period-card { background: linear-gradient(145deg, #eef2ff, #e2e8ff); border: 1px solid #c7d2fe; border-radius: 16px; padding: 16px 18px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.12); min-height: 118px; justify-content: center; }
    .period-status { margin: 0; font-size: 13px; color: #1e293b; font-weight: 600; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .period-status span { font-size: 12px; color: #475569; font-weight: 500; }
    .period-status.has-value { color: #0f172a; }
    .period-controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch; }
    .period-field { flex: 1 1 150px; display: flex; flex-direction: column; gap: 6px; padding: 10px 12px; border-radius: 12px; border: 1px solid #c7d2fe; background: rgba(255, 255, 255, 0.9); box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.08); }
    .period-field label { font-size: 12px; font-weight: 600; color: #312e81; letter-spacing: 0.01em; }
    .period-field input { width: 100%; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #1d4ed8; padding: 0; height: 24px; }
    .period-field input:focus { outline: none; }
    .period-field input::-webkit-calendar-picker-indicator { filter: invert(21%) sepia(94%) saturate(3396%) hue-rotate(221deg) brightness(95%) contrast(97%); cursor: pointer; }
    .period-clear { flex: 0 0 auto; border: none; background: rgba(15, 23, 42, 0.07); color: #1f2937; padding: 9px 16px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: background 0.12s ease; }
    .period-clear:hover { background: rgba(15, 23, 42, 0.12); }
    .filter-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; align-items: center; }
    .filter-actions-left { display: flex; gap: 8px; }
    .filter-actions button { margin: 0; }
    .filter-hint { margin-top: 8px; font-size: 12px; color: #666; }
    #recordActions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    #recordActions label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      white-space: nowrap;
    }
    #recordActions button {
      font-size: 13px;
      padding: 7px 14px;
      white-space: nowrap;
    }
    #selectedCount {
      color: #666;
      font-size: 13px;
      white-space: nowrap;
    }
    details.section { margin: 20px 0; }
    details.section > summary { cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; }
    details.section > summary::-webkit-details-marker { display: none; }
    details.section > summary h3 { margin: 0; }
    details.section > summary::after { content: '▼'; font-size: 12px; margin-left: 8px; color: #666; }
    details.section[open] > summary::after { content: '▲'; }
    .records-placeholder { padding: 20px; text-align: center; color: #666; }
    @media (max-width: 600px) {
      .records-table thead { display: none; }
      .records-table table { border-collapse: separate; border-spacing: 0 12px; }
      .records-table tbody { display: block; }
      .records-table tr {
        display: grid;
        grid-template-columns: 32px 1fr 88px;
        grid-template-areas:
          "select time photo"
          "select emp photo"
          "select name photo";
        gap: 4px 12px;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
      }
      .records-table td {
        border: none;
        padding: 0;
        font-size: 13px;
      }
      .records-table td.select-cell { grid-area: select; padding-top: 4px; }
      .records-table td.time-cell { grid-area: time; font-weight: 600; }
      .records-table td.emp-cell { grid-area: emp; }
      .records-table td.name-cell { grid-area: name; }
      .records-table td.photo-cell { grid-area: photo; text-align: center; }
      .photo-preview { height: 48px; }
      .section-header { flex-direction: row; align-items: center; }
      .section-header h3 { font-size: 18px; }
      .section-header-actions { gap: 6px; font-size: 11px; }
      .section-header-actions button { padding: 6px 8px; font-size: 11px; min-width: 0; }
      .records-table td.name-cell { display: none; }
      .emp-inline-name { display: inline-block; font-size: 13px; color: #555; }
      .record-filter-row { flex-direction: column; align-items: stretch; }
      #recordActions { gap: 8px; }
      #recordActions label { font-size: 12px; }
      #recordActions button { font-size: 12px; padding: 6px 10px; }
      #selectedCount { font-size: 12px; }
      .filter-group { width: 100%; }
      .filter-actions { flex-direction: column; align-items: stretch; gap: 10px; }
      .filter-actions-left { width: 100%; gap: 6px; }
      .filter-actions-left button { flex: 1 1 auto; }
      .filter-hint { font-size: 11px; }
      .filters { gap: 12px; }
      .filters .filter-id, .filters .filter-period { min-width: 0; flex: 1 1 100%; }
      .period-controls { width: 100%; }
      .period-field { flex: 1 1 calc(50% - 6px); }
      .period-clear { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- 로그인 폼 -->
  <div id="loginForm" class="login-form">
    <h2>관리자 로그인</h2>
    <div id="loginError" class="error hidden"></div>
    <div>
      <label>비밀번호</label><br />
      <input type="password" id="adminPassword" placeholder="관리자 비밀번호" />
    </div>
    <button class="primary" onclick="login()">로그인</button>
  </div>

  <!-- 관리자 페이지 -->
  <div id="adminPanel" class="hidden">
    <div class="header">
      <h1>출퇴근 관리자 페이지</h1>
      <button onclick="logout()">로그아웃</button>
    </div>

    <!-- 등록 기록 조회 -->
    <div class="section">
      <div class="section-header">
        <h3>등록 기록 조회</h3>
        <div class="section-header-actions">
          <button onclick="confirmDownload('csv')">CSV 다운로드</button>
          <button onclick="confirmDownload('consent')">동의 로그 다운로드</button>
        </div>
      </div>
      <div class="filters">
        <div class="filter-group filter-id">
          <label class="filter-label" for="searchEmpId">사번</label>
          <div class="input-card">
            <input type="text" id="searchEmpId" placeholder="사번 입력 (예: 170200)" />
            <p style="margin: 0; font-size: 12px; color: #1e40af; font-weight: 500;">필요시 숫자만 입력해주세요.</p>
          </div>
        </div>
        <div class="filter-group filter-period">
          <span class="filter-label">기간</span>
          <div class="period-card">
            <p class="period-status" id="periodStatus">선택된 기간 없음</p>
            <div class="period-controls">
              <div class="period-field">
                <label for="dateFilter">일자 선택</label>
                <input type="date" id="dateFilter" />
              </div>
              <div class="period-field">
                <label for="monthFilter">월 선택</label>
                <input type="month" id="monthFilter" />
              </div>
              <button type="button" class="period-clear" id="periodClearBtn">기간 삭제</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-actions">
        <div class="filter-actions-left">
          <button class="primary" onclick="loadRecords()">조회</button>
          <button onclick="resetRecordFilters()">필터 초기화</button>
        </div>
      </div>
      <p class="filter-hint">사번 또는 기간을 선택한 뒤 조회 버튼을 눌러주세요. 기간은 일 / 월 중 한 가지 방식만 사용됩니다.</p>
      <div id="recordActions">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords(this)" />
          전체 선택
        </label>
        <button class="danger" id="deleteSelectedBtn" onclick="deleteSelectedRecords()" disabled>선택 삭제</button>
        <button class="danger" id="deleteAllBtn" onclick="deleteAllRecords()" disabled>전체 삭제</button>
        <span id="selectedCount" style="color: #666;">0건 선택됨</span>
      </div>
      <div id="recordsTable" class="records-placeholder">조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.</div>
    </div>

    <!-- 기기 재등록 요청 관리 -->
    <details class="section" id="deviceRequestsSection">
      <summary>
        <h3 style="display: inline;">기기 재등록 요청 관리</h3>
        <span id="deviceRequestBadge" class="pending-pill hidden">대기 0건</span>
      </summary>
      <div class="info-box">
        <strong>안내:</strong> 사용자가 기기 변경을 요청한 경우, 승인하면 해당 사번의 모든 등록 기록의 기기 ID가 업데이트됩니다.
      </div>
      <div style="margin: 15px 0;">
        <label>상태 필터</label>
        <select id="requestStatusFilter" onchange="loadDeviceRequests()">
          <option value="all">전체</option>
          <option value="pending" selected>대기 중</option>
          <option value="approved">승인됨</option>
          <option value="rejected">거부됨</option>
        </select>
        <button class="primary" onclick="loadDeviceRequests()">새로고침</button>
        <span id="requestCount" style="margin-left: 10px; color: #666;"></span>
      </div>
      <div id="deviceRequestsTable"></div>
    </details>

    <!-- 스토리지 사용량 -->
    <details class="section" id="storageUsageSection">
      <summary>
        <h3 style="display: inline;">스토리지 사용량</h3>
      </summary>
      <div class="info-box">
        <div id="storageUsageInfo">로딩 중...</div>
        <button class="primary" onclick="loadStorageUsage()" style="margin-top: 10px;">새로고침</button>
      </div>
    </details>

    <!-- 허용된 IP 관리 -->
    <details class="section" id="allowedIpsSection">
      <summary>
        <h3 style="display: inline;">허용된 IP 관리</h3>
      </summary>
      <div class="info-box">
        <strong>현재 접속 IP:</strong> <span id="currentIp">확인 중...</span>
        <button class="primary" onclick="addCurrentIp()" style="margin-left: 10px;">현재 IP 추가</button>
      </div>
      <div style="margin: 15px 0;">
        <label>IP/CIDR:</label>
        <input type="text" id="newIpInput" placeholder="예: 192.168.1.1/32 또는 192.168.1.0/24" style="width: 300px;">
        <label style="margin-left: 10px;">설명:</label>
        <input type="text" id="newIpDescription" placeholder="예: 집 컴퓨터" style="width: 200px;">
        <button class="primary" onclick="addAllowedIp()">IP 추가</button>
        <button class="primary" onclick="loadAllowedIps()" style="margin-left: 10px;">새로고침</button>
      </div>
      <div id="allowedIpsTable"></div>
    </details>

    <!-- 기기 ID 업데이트 -->
    <details class="section">
      <summary><h3 style="display: inline;">기기 ID 업데이트</h3></summary>
      <p>다른 기기에서 등록된 기록이 있는 경우, 새 기기 ID로 업데이트할 수 있습니다.</p>
      <div>
        <label>사번</label>
        <input type="text" id="updateEmpId" placeholder="사번 입력" />
        <label>새 기기 ID</label>
        <input type="text" id="updateDeviceId" placeholder="새 기기 ID 입력" />
        <button class="primary" onclick="updateDeviceId()">기기 ID 업데이트</button>
      </div>
      <div id="updateResult" class="hidden"></div>
    </details>
  </div>

  <div id="pendingModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="pendingModalTitle">
    <div class="modal-dialog">
      <h3 id="pendingModalTitle">기기 재등록 요청 알림</h3>
      <p id="pendingModalMessage">기기 재등록 요청이 대기 중입니다.</p>
      <div class="modal-actions">
        <button id="pendingModalViewBtn" class="primary">요청 확인</button>
        <button id="pendingModalCloseBtn" class="secondary">나중에 보기</button>
      </div>
    </div>
  </div>

  <script>
    let adminToken = localStorage.getItem('admin_token');
    let cachedRecords = [];
    const selectedRecordIds = new Set();
    let pendingRequestCount = 0;
    let pendingBadgeTimer = null;
    let pendingModalShown = false;
    const deviceRequestsSection = document.getElementById('deviceRequestsSection');
    const deviceRequestBadge = document.getElementById('deviceRequestBadge');
    const pendingModal = document.getElementById('pendingModal');
    const pendingModalMessage = document.getElementById('pendingModalMessage');
    const pendingModalViewBtn = document.getElementById('pendingModalViewBtn');
    const pendingModalCloseBtn = document.getElementById('pendingModalCloseBtn');
    const dateFilterInput = document.getElementById('dateFilter');
    const monthFilterInput = document.getElementById('monthFilter');
    const periodStatus = document.getElementById('periodStatus');
    const periodClearBtn = document.getElementById('periodClearBtn');
    function formatDisplayDate(value, type) {
      if (!value) return '';
      if (type === 'month') {
        const [year, month] = value.split('-');
        return `${year}.${month}`;
      }
      const [year, month, day] = value.split('-');
      return `${year}.${month}.${day}`;
    }

    function updatePeriodStatus() {
      if (!periodStatus) return;
      const dateValue = dateFilterInput?.value;
      const monthValue = monthFilterInput?.value;
      let text = '선택된 기간 없음';
      if (dateValue) {
        text = `선택된 기간: ${formatDisplayDate(dateValue, 'date')} (일자)`;
      } else if (monthValue) {
        text = `선택된 기간: ${formatDisplayDate(monthValue, 'month')} (월)`;
      }
      periodStatus.textContent = text;
      periodStatus.classList.toggle('has-value', Boolean(dateValue || monthValue));
    }

    function clearPeriodSelection() {
      if (dateFilterInput) dateFilterInput.value = '';
      if (monthFilterInput) monthFilterInput.value = '';
      updatePeriodStatus();
    }

    if (dateFilterInput) {
      dateFilterInput.addEventListener('change', () => {
        if (dateFilterInput.value && monthFilterInput) {
          monthFilterInput.value = '';
        }
        onDateFilterChange();
        updatePeriodStatus();
      });
    }

    if (monthFilterInput) {
      monthFilterInput.addEventListener('change', () => {
        if (monthFilterInput.value && dateFilterInput) {
          dateFilterInput.value = '';
        }
        onMonthFilterChange();
        updatePeriodStatus();
      });
    }

    if (periodClearBtn) {
      periodClearBtn.addEventListener('click', () => {
        clearPeriodSelection();
      });
    }

    updatePeriodStatus();

    function showPendingRequestModal(count) {
      if (!pendingModal || !pendingModalMessage) return;
      const message =
        count === 1
          ? '기기 재등록 요청이 1건 대기 중입니다.'
          : `기기 재등록 요청이 ${count}건 대기 중입니다.`;
      pendingModalMessage.textContent = message;
      pendingModal.classList.add('show');
      pendingModalShown = true;
      if (pendingModalViewBtn) {
        pendingModalViewBtn.focus();
      }
    }

    function hidePendingRequestModal() {
      if (!pendingModal) return;
      pendingModal.classList.remove('show');
    }

    if (pendingModalViewBtn) {
      pendingModalViewBtn.addEventListener('click', () => {
        hidePendingRequestModal();
        if (deviceRequestsSection && !deviceRequestsSection.open) {
          deviceRequestsSection.open = true;
        }
        loadDeviceRequests();
      });
    }

    if (pendingModalCloseBtn) {
      pendingModalCloseBtn.addEventListener('click', () => {
        hidePendingRequestModal();
      });
    }

    if (pendingModal) {
      pendingModal.addEventListener('click', (event) => {
        if (event.target === pendingModal) {
          hidePendingRequestModal();
        }
      });
    }

    function updatePendingRequestBadge(count, options = {}) {
      const { alertOnIncrease = false, forceModal = false } = options;
      if (!deviceRequestBadge) return;

      if (count > 0) {
        deviceRequestBadge.textContent = `대기 ${count}건`;
        deviceRequestBadge.classList.remove('hidden');
        if (alertOnIncrease && count > pendingRequestCount) {
          showPendingRequestModal(count);
        } else if (forceModal && !pendingModalShown) {
          showPendingRequestModal(count);
        }
      } else {
        deviceRequestBadge.classList.add('hidden');
        hidePendingRequestModal();
        pendingModalShown = false;
      }
      pendingRequestCount = count;
    }

    async function refreshPendingRequestBadge(options = {}) {
      if (!adminToken || !deviceRequestBadge) return;

      try {
        const res = await fetch('/api/admin/device-requests?status=pending', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || '조회 실패');

        const count = Array.isArray(data.requests) ? data.requests.length : 0;
        updatePendingRequestBadge(count, options);
      } catch (err) {
        console.error('pending request badge 업데이트 실패:', err);
      }
    }

    function startPendingRequestWatcher() {
      if (pendingBadgeTimer) {
        clearInterval(pendingBadgeTimer);
      }
      refreshPendingRequestBadge({ forceModal: true });
      pendingBadgeTimer = setInterval(() => {
        refreshPendingRequestBadge({ alertOnIncrease: true });
      }, 60000);
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        refreshPendingRequestBadge({ alertOnIncrease: true });
      }
    });

    function confirmDownload(type) {
      if (type === 'csv') {
        if (confirm('CSV 파일을 다운로드할까요?')) {
          downloadCSV();
        }
      } else if (type === 'consent') {
        if (confirm('동의 로그 파일을 다운로드할까요?')) {
          downloadConsentLogs();
        }
      }
    }

    function setRecordsPlaceholder(message) {
      const tableDiv = document.getElementById('recordsTable');
      if (!tableDiv) return;
      tableDiv.className = 'records-placeholder';
      tableDiv.innerHTML = `<p class="records-placeholder">${message}</p>`;
    }

    function onDateFilterChange() {
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (dateInput && monthInput && dateInput.value) {
        monthInput.value = '';
      }
    }

    function onMonthFilterChange() {
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (dateInput && monthInput && monthInput.value) {
        dateInput.value = '';
      }
    }

    function resetRecordFilters() {
      const empInput = document.getElementById('searchEmpId');
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (empInput) empInput.value = '';
      if (dateInput) dateInput.value = '';
      if (monthInput) monthInput.value = '';
      clearPeriodSelection();
      updatePeriodStatus();
      cachedRecords = [];
      resetSelectionState();
      setRecordsPlaceholder('조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.');
    }

    // 페이지 로드 시 토큰 확인
    if (adminToken) {
      checkAuth();
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function resetSelectionState() {
      selectedRecordIds.clear();
      const selectAll = document.getElementById('selectAllRecords');
      if (selectAll) selectAll.checked = false;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const countSpan = document.getElementById('selectedCount');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      const selectAll = document.getElementById('selectAllRecords');

      if (countSpan) countSpan.textContent = `${selectedRecordIds.size}건 선택됨`;
      if (deleteBtn) deleteBtn.disabled = selectedRecordIds.size === 0;
      if (deleteAllBtn) deleteAllBtn.disabled = cachedRecords.length === 0;
      if (selectAll) {
        selectAll.checked = cachedRecords.length > 0 && selectedRecordIds.size === cachedRecords.length;
        selectAll.indeterminate = selectedRecordIds.size > 0 && selectedRecordIds.size < cachedRecords.length;
      }
    }


    function toggleRecordSelection(checkbox) {
      const recordId = Number(checkbox.dataset.id);
      if (checkbox.checked) {
        selectedRecordIds.add(recordId);
      } else {
        selectedRecordIds.delete(recordId);
      }
      updateSelectedCount();
    }

    function toggleAllRecords(checkbox) {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      if (checkbox.checked) {
        cachedRecords.forEach(record => selectedRecordIds.add(record.recordId));
        checkboxes.forEach(cb => cb.checked = true);
      } else {
        selectedRecordIds.clear();
        checkboxes.forEach(cb => cb.checked = false);
      }
      updateSelectedCount();
    }

    async function deleteSelectedRecords() {
      if (selectedRecordIds.size === 0) return;
      if (!confirm(`${selectedRecordIds.size}개의 기록을 삭제하시겠습니까?\n관련 사진 파일도 함께 삭제됩니다.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ recordIds: Array.from(selectedRecordIds) })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`✅ ${data.deleted}건 삭제, ${data.deletedFiles}개 파일 제거`);
          await loadRecords();
        } else {
          alert('❌ ' + (data.message || '삭제 실패'));
        }
      } catch (e) {
        alert('삭제 중 오류가 발생했습니다.');
        console.error('선택 삭제 오류:', e);
      }
    }

    async function deleteAllRecords() {
      if (cachedRecords.length === 0) {
        alert('삭제할 기록이 없습니다.');
        return;
      }
      if (!confirm(`총 ${cachedRecords.length}건의 모든 기록을 삭제하시겠습니까?\n관련 사진 파일도 함께 삭제됩니다.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ deleteAll: true })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`✅ 전체 삭제 완료 (${data.deleted}건, 파일 ${data.deletedFiles}개 제거)`);
          await loadRecords();
        } else {
          alert('❌ ' + (data.message || '전체 삭제 실패'));
        }
      } catch (e) {
        alert('전체 삭제 중 오류가 발생했습니다.');
        console.error('전체 삭제 오류:', e);
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/admin/check', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          cachedRecords = [];
          resetSelectionState();
          setRecordsPlaceholder('조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.');
          loadDeviceRequests();
          startPendingRequestWatcher();
        } else {
          logout();
        }
      } catch {
        logout();
      }
    }

    async function login() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!password) {
        errorDiv.textContent = '비밀번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        
        if (data.ok) {
          adminToken = data.token;
          localStorage.setItem('admin_token', adminToken);
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          errorDiv.classList.add('hidden');
          cachedRecords = [];
          resetSelectionState();
          setRecordsPlaceholder('조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.');
          loadDeviceRequests();
          startPendingRequestWatcher();
        } else {
          errorDiv.textContent = data.message || '로그인 실패';
          errorDiv.classList.remove('hidden');
        }
      } catch (e) {
        errorDiv.textContent = '로그인 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    function logout() {
      localStorage.removeItem('admin_token');
      adminToken = null;
      if (pendingBadgeTimer) {
        clearInterval(pendingBadgeTimer);
        pendingBadgeTimer = null;
      }
      pendingRequestCount = 0;
      pendingModalShown = false;
      if (deviceRequestBadge) deviceRequestBadge.classList.add('hidden');
      hidePendingRequestModal();
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
    }

    async function loadRecords() {
      const empInput = document.getElementById('searchEmpId');
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      const empId = empInput ? empInput.value.trim() : '';
      const dateValue = dateInput ? dateInput.value : '';
      const monthValue = monthInput ? monthInput.value : '';

      if (dateValue && monthValue) {
        alert('날짜와 월은 동시에 선택할 수 없습니다.');
        return;
      }

      if (!empId && !dateValue && !monthValue) {
        alert('사번 또는 날짜/월을 선택해주세요.');
        return;
      }

      const params = new URLSearchParams();
      if (empId) params.set('employeeId', empId);
      if (dateValue) params.set('date', dateValue);
      if (monthValue) params.set('month', monthValue);
      const queryString = params.toString();
      const url = `/api/admin/records${queryString ? `?${queryString}` : ''}`;
      setRecordsPlaceholder('기록을 불러오는 중입니다...');
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          cachedRecords = data.records || [];
          displayRecords(cachedRecords);
        } else {
          cachedRecords = [];
          setRecordsPlaceholder(data.message ? `기록 조회 실패: ${data.message}` : '기록 조회에 실패했습니다.');
        }
      } catch (e) {
        cachedRecords = [];
        setRecordsPlaceholder('기록 조회 중 오류가 발생했습니다.');
      } finally {
        resetSelectionState();
      }
    }

    function displayRecords(records) {
      const tableDiv = document.getElementById('recordsTable');
      tableDiv.className = 'records-table';
      if (!records || records.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">등록 기록이 없습니다.</p>';
        updateSelectedCount();
        return;
      }

      // 시간 포맷팅 함수
      const formatTime = (timeStr, shortFormat = false) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          const pad = (n) => String(n).padStart(2, '0');
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          if (shortFormat) {
            return `${month}/${day}`;
          }
          const hour = pad(date.getHours());
          const minute = pad(date.getMinutes());
          const second = pad(date.getSeconds());
          return `${year}/${month}/${day} ${hour}:${minute}:${second}`;
        } catch {
          return timeStr;
        }
      };

      let html = '<table><thead><tr><th style="width: 42px;">선택</th><th>시간</th><th>사번</th><th>이름</th><th>사진</th></tr></thead><tbody>';
      records.forEach(record => {
        const imageUrl = record.file || '';
        const hasImage = Boolean(imageUrl);
        const cleanupTime = record.photo_deleted_at
          ? '사진 삭제됨'
          : record.cleanup_scheduled_at
            ? `삭제 예정 ${formatTime(record.cleanup_scheduled_at, true)}`
            : '보관 중';
        const safeNameAttr = (record.name || '-').replace(/"/g, '&quot;');
        html += `<tr>
          <td class="select-cell">
            <input type="checkbox" class="record-checkbox" data-id="${record.recordId}" onchange="toggleRecordSelection(this)" />
          </td>
          <td class="time-cell">${formatTime(record.server_time)}</td>
          <td class="emp-cell"><strong>${record.employee_id || '-'}</strong><span class="emp-inline-name">${record.name || '-'}</span></td>
          <td class="name-cell">
            <span class="truncate" title="${safeNameAttr}">${record.name || '-'}</span>
          </td>
          <td class="photo-cell">
            ${hasImage ? `
              <div style="display: inline-flex; flex-direction: column; align-items: center;">
                <img src="${imageUrl}"
                     alt="미리보기"
                     class="photo-preview"
                     onclick="showImageModal('${imageUrl}', '사진 미리보기')" />
              </div>
            ` : '<span style="color: #999;">-</span>'}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
      updateSelectedCount();
    }

    // 이미지 모달 표시 함수
    function showImageModal(imageUrl, fileName) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
      `;
      modal.onclick = () => {
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
      img.onclick = (e) => e.stopPropagation();
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '✕';
      closeBtn.style.cssText = `
        position: absolute; top: 20px; right: 20px;
        width: 40px; height: 40px; border-radius: 50%;
        background: rgba(255,255,255,0.9); border: none;
        font-size: 24px; cursor: pointer; color: #333;
        display: flex; align-items: center; justify-content: center;
      `;
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };
      
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
    }

    async function updateDeviceId() {
      const empId = document.getElementById('updateEmpId').value.trim();
      const newDeviceId = document.getElementById('updateDeviceId').value.trim();
      const resultDiv = document.getElementById('updateResult');
      
      if (!empId || !newDeviceId) {
        resultDiv.innerHTML = '<div class="error">사번과 새 기기 ID를 모두 입력해주세요.</div>';
        resultDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/update-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ employeeId: empId, deviceId: newDeviceId })
        });
        const data = await res.json();
        
        if (data.ok) {
          resultDiv.innerHTML = `<div class="success">✅ 기기 ID가 성공적으로 업데이트되었습니다. (${data.updated}개 기록 업데이트)</div>`;
          resultDiv.classList.remove('hidden');
          loadRecords(); // 기록 새로고침
        } else {
          resultDiv.innerHTML = `<div class="error">❌ ${data.message || '업데이트 실패'}</div>`;
          resultDiv.classList.remove('hidden');
        }
      } catch (e) {
        resultDiv.innerHTML = '<div class="error">업데이트 중 오류가 발생했습니다.</div>';
        resultDiv.classList.remove('hidden');
      }
    }

    async function downloadCSV() {
      try {
        const res = await fetch('/api/admin/download-csv', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          alert('CSV 다운로드 실패');
        }
      } catch (e) {
        alert('CSV 다운로드 중 오류가 발생했습니다.');
      }
    }

    async function downloadConsentLogs() {
      try {
        const res = await fetch('/api/admin/download-consent-logs', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.status === 204) {
          alert('저장된 동의 로그가 없습니다.');
          return;
        }
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `consent_logs_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          const data = await res.json().catch(() => ({}));
          alert('동의 로그 다운로드 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (e) {
        alert('동의 로그 다운로드 중 오류가 발생했습니다.');
        console.error('download consent logs error:', e);
      }
    }

    // 기기 재등록 요청 목록 조회
    async function loadDeviceRequests() {
      const status = document.getElementById('requestStatusFilter').value;
      const url = `/api/admin/device-requests?status=${status}`;
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          displayDeviceRequests(data.requests);
          if (status === 'pending') {
            updatePendingRequestBadge(Array.isArray(data.requests) ? data.requests.length : 0, { alertOnIncrease: false });
          } else {
            await refreshPendingRequestBadge({ alertOnIncrease: false });
          }
        } else {
          alert('요청 목록 조회 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (e) {
        alert('요청 목록 조회 중 오류가 발생했습니다.');
      }
    }

    // 기기 재등록 요청 목록 표시
    function displayDeviceRequests(requests) {
      const tableDiv = document.getElementById('deviceRequestsTable');
      const countSpan = document.getElementById('requestCount');
      
      if (!requests || requests.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">요청이 없습니다.</p>';
        countSpan.textContent = '';
        return;
      }

      // 시간 포맷팅 함수
      const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          return date.toLocaleString('ko-KR', { 
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return timeStr;
        }
      };

      countSpan.textContent = `총 ${requests.length}건`;
      
      let html = '<table><thead><tr><th>요청일시</th><th>사번</th><th>이름</th><th>기기 ID</th><th>상태</th><th>처리일시</th><th>작업</th></tr></thead><tbody>';
      requests.forEach(req => {
        const statusClass = req.status === 'pending' ? 'status-pending' : 
                           req.status === 'approved' ? 'status-approved' : 
                           'status-rejected';
        const statusText = req.status === 'pending' ? '⏳ 대기' : 
                          req.status === 'approved' ? '✅ 승인' : 
                          '❌ 거부';
        const processTime = formatTime(req.approvedAt || req.rejectedAt);
        const actions = req.status === 'pending' ? 
          `<button class="primary" onclick="approveRequest('${req.id}')">승인</button>
           <button class="danger" onclick="rejectRequest('${req.id}')">거부</button>` : 
          '-';
        
        html += `<tr>
          <td>${formatTime(req.requestedAt)}</td>
          <td><strong>${req.employeeId || '-'}</strong></td>
          <td>${req.name || '-'}</td>
          <td style="font-size: 0.85em; word-break: break-all; max-width: 200px;">${req.deviceId || '-'}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${processTime}</td>
          <td>${actions}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    // 요청 승인
    async function approveRequest(requestId) {
      if (!confirm('이 요청을 승인하시겠습니까? 승인하면 해당 사번의 모든 등록 기록의 기기 ID가 업데이트됩니다.')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/approve-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert(`✅ 승인 완료 (${data.updated}개 기록 업데이트)`);
          loadDeviceRequests();
          loadRecords(); // 등록 기록도 새로고침
        } else {
          alert('❌ ' + (data.message || '승인 실패'));
        }
      } catch (e) {
        alert('승인 처리 중 오류가 발생했습니다.');
        console.error('승인 오류:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }

    // 요청 거부
    async function rejectRequest(requestId) {
      if (!confirm('이 요청을 거부하시겠습니까?')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/reject-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('✅ 거부 완료');
          loadDeviceRequests();
        } else {
          alert('❌ ' + (data.message || '거부 실패'));
        }
      } catch (e) {
        alert('거부 처리 중 오류가 발생했습니다.');
        console.error('거부 오류:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }

    // ========== IP 관리 기능 ==========
    async function loadCurrentIp() {
      if (!adminToken) return;
      try {
        const res = await fetch('/api/admin/my-ip', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (data.ok && data.ip) {
          document.getElementById('currentIp').textContent = data.ip;
        }
      } catch (err) {
        console.error('현재 IP 조회 실패:', err);
        document.getElementById('currentIp').textContent = '조회 실패';
      }
    }

    async function loadAllowedIps() {
      if (!adminToken) return;
      try {
        const res = await fetch('/api/admin/allowed-ips', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (data.ok) {
          displayAllowedIps(data.ips || []);
        } else {
          alert('IP 목록 조회 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (err) {
        console.error('IP 목록 조회 실패:', err);
        alert('IP 목록 조회 중 오류가 발생했습니다.');
      }
    }

    function displayAllowedIps(ips) {
      const tableDiv = document.getElementById('allowedIpsTable');
      
      if (!ips || ips.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">등록된 IP가 없습니다.</p>';
        return;
      }

      const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          return date.toLocaleString('ko-KR', { 
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return timeStr;
        }
      };

      let html = '<table><thead><tr><th>IP/CIDR</th><th>설명</th><th>등록일시</th><th>작업</th></tr></thead><tbody>';
      ips.forEach(ip => {
        html += `
          <tr>
            <td><code>${ip.ip_cidr}</code></td>
            <td>${ip.description || '-'}</td>
            <td>${formatTime(ip.created_at)}</td>
            <td>
              <button class="danger" onclick="removeAllowedIp(${ip.id})">삭제</button>
            </td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    async function addCurrentIp() {
      if (!adminToken) return;
      const currentIp = document.getElementById('currentIp').textContent;
      if (currentIp === '확인 중...' || currentIp === '조회 실패') {
        alert('현재 IP를 먼저 확인해주세요.');
        return;
      }
      
      const description = prompt('설명을 입력하세요 (선택사항):', '집 컴퓨터');
      if (description === null) return; // 취소

      await addAllowedIpWithValue(currentIp + '/32', description);
    }

    async function addAllowedIp() {
      if (!adminToken) return;
      const ipInput = document.getElementById('newIpInput');
      const descInput = document.getElementById('newIpDescription');
      const ipCidr = ipInput.value.trim();
      const description = descInput.value.trim() || null;

      if (!ipCidr) {
        alert('IP/CIDR를 입력해주세요.');
        return;
      }

      await addAllowedIpWithValue(ipCidr, description);
    }

    async function addAllowedIpWithValue(ipCidr, description) {
      if (!adminToken) return;
      try {
        const res = await fetch('/api/admin/allowed-ips', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ip_cidr: ipCidr,
            description: description
          })
        });
        const data = await res.json();
        if (data.ok) {
          alert('IP가 추가되었습니다.');
          document.getElementById('newIpInput').value = '';
          document.getElementById('newIpDescription').value = '';
          loadAllowedIps();
        } else {
          alert('IP 추가 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (err) {
        console.error('IP 추가 실패:', err);
        alert('IP 추가 중 오류가 발생했습니다.');
      }
    }

    async function removeAllowedIp(id) {
      if (!adminToken) return;
      if (!confirm('이 IP를 삭제하시겠습니까?')) return;

      try {
        const res = await fetch(`/api/admin/allowed-ips/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (data.ok) {
          alert('IP가 삭제되었습니다.');
          loadAllowedIps();
        } else {
          alert('IP 삭제 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (err) {
        console.error('IP 삭제 실패:', err);
        alert('IP 삭제 중 오류가 발생했습니다.');
      }
    }

    // ========== 스토리지 사용량 조회 ==========
    async function loadStorageUsage() {
      if (!adminToken) return;
      const infoDiv = document.getElementById('storageUsageInfo');
      infoDiv.innerHTML = '로딩 중...';
      
      try {
        const res = await fetch('/api/admin/storage-usage', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (data.ok) {
          displayStorageUsage(data);
        } else {
          infoDiv.innerHTML = '<span style="color: #dc3545;">조회 실패: ' + (data.message || '알 수 없는 오류') + '</span>';
        }
      } catch (err) {
        console.error('스토리지 사용량 조회 실패:', err);
        infoDiv.innerHTML = '<span style="color: #dc3545;">조회 중 오류가 발생했습니다.</span>';
      }
    }

    function displayStorageUsage(data) {
      const infoDiv = document.getElementById('storageUsageInfo');
      
      // 스토리지 타입 확인
      const storageType = data.storageType || 'unknown';
      const isB2 = storageType === 'backblaze-b2';
      const isFileSystem = storageType === 'file-system';
      
      let html = '<div style="line-height: 1.8;">';
      
      // 스토리지 타입 표시
      html += `<div><strong>스토리지 타입:</strong> `;
      if (isB2) {
        html += '<span style="color: #28a745;">Backblaze B2</span>';
      } else if (isFileSystem) {
        html += '<span style="color: #666;">Render 파일 시스템</span>';
      } else {
        html += '<span style="color: #666;">' + storageType + '</span>';
      }
      html += '</div>';
      
      if (isB2) {
        // B2 사용량 정보
        const usedGB = data.currentUsageGB || 0;
        const limitGB = data.limitGB || 10;
        const usagePercent = data.usagePercent || 0;
        const remainingGB = data.remainingGB || 0;
        
        // 경고 색상 결정
        let usageColor = '#28a745'; // 초록
        if (usagePercent >= 80) {
          usageColor = '#dc3545'; // 빨강 (80% 이상)
        } else if (usagePercent >= 60) {
          usageColor = '#ffc107'; // 노랑 (60% 이상)
        }
        
        html += `<div><strong>사용량:</strong> <span style="color: ${usageColor}; font-weight: bold;">${usedGB.toFixed(2)} GB</span> / ${limitGB} GB (${usagePercent.toFixed(1)}%)</div>`;
        html += `<div><strong>남은 용량:</strong> ${remainingGB.toFixed(2)} GB</div>`;
        html += `<div style="margin-top: 10px;">`;
        html += `<div style="background: #e9ecef; border-radius: 4px; height: 24px; position: relative; overflow: hidden;">`;
        html += `<div style="background: ${usageColor}; height: 100%; width: ${Math.min(usagePercent, 100)}%; transition: width 0.3s;"></div>`;
        html += `</div></div>`;
        
        if (data.isWarning || usagePercent >= 80) {
          html += `<div style="margin-top: 10px; padding: 8px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px; color: #721c24;">`;
          html += `<strong>⚠️ 경고:</strong> 스토리지 사용량이 80%를 초과했습니다. 파일을 정리하거나 백업을 생성해주세요.`;
          html += `</div>`;
        } else if (usagePercent >= 60) {
          html += `<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; color: #856404;">`;
          html += `<strong>💡 알림:</strong> 스토리지 사용량이 60%를 초과했습니다.`;
          html += `</div>`;
        }
        
        // 파일 통계
        const fileCount = data.fileCount || 0;
        html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">`;
        html += `<div><strong>파일 수:</strong> ${fileCount.toLocaleString()}개</div>`;
        html += `</div>`;
        
        // 에러 메시지 표시
        if (data.error) {
          html += `<div style="margin-top: 10px; padding: 8px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px; color: #721c24;">`;
          html += `<strong>❌ 오류:</strong> ${data.error}`;
          html += `</div>`;
        }
      } else if (isFileSystem) {
        html += `<div style="color: #666; margin-top: 10px;">`;
        html += `Render 파일 시스템을 사용 중입니다. 사용량 통계는 제공되지 않습니다.`;
        html += `</div>`;
      } else {
        html += `<div style="color: #666; margin-top: 10px;">`;
        html += `스토리지 정보를 가져올 수 없습니다.`;
        html += `</div>`;
      }
      
      html += '</div>';
      infoDiv.innerHTML = html;
    }

    // 페이지 로드 시 현재 IP 확인 및 IP 목록 로드, 스토리지 사용량 조회
    if (adminToken) {
      loadCurrentIp();
      loadAllowedIps();
      loadStorageUsage();
    }
  </script>
</body>
</html>

