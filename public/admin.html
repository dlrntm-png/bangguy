<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê´€ë¦¬ì í˜ì´ì§€ - ì¶œí‡´ê·¼ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
    .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .section h3 { margin-top: 0; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; font-weight: bold; color: #495057; }
    tr:hover { background-color: #f9f9f9; }
    button { padding: 8px 16px; margin: 4px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff; transition: all 0.2s; }
    button:hover { background: #f0f0f0; transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.primary { background: #007bff; color: white; border-color: #007bff; }
    button.primary:hover { background: #0056b3; }
    button.danger { background: #dc3545; color: white; border-color: #dc3545; }
    button.danger:hover { background: #c82333; }
    input, select { padding: 8px; margin: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
    .login-form { max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .error { color: #dc3545; margin: 10px 0; padding: 8px; background: #f8d7da; border-radius: 4px; }
    .success { color: #28a745; margin: 10px 0; padding: 8px; background: #d4edda; border-radius: 4px; }
    .hidden { display: none; }
    .info-box { padding: 12px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px; margin: 10px 0; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .pending-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: #fef2f2;
      color: #b91c1c;
    }
    .loading { opacity: 0.6; pointer-events: none; }
    .photo-preview {
      width: auto;
      height: 32px;
      max-width: 100%;
      border: 1px solid #d4d4d8;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
      display: block;
      object-fit: contain;
      object-position: center;
      background: #fff;
      image-orientation: from-image;
    }
    .photo-preview:hover { transform: scale(1.05); }
    .truncate { max-width: 120px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
    .name-cell { max-width: 120px; }
    .emp-inline-name { display: none; margin-left: 8px; font-weight: 500; color: #333; }
    .section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
    .section-header h3 { margin: 0; }
    .section-header-actions { display: flex; gap: 8px; font-size: 13px; }
    .section-header-actions button { padding: 6px 10px; font-size: 12px; white-space: nowrap; min-width: 120px; cursor: pointer; }
    .records-table table { width: 100%; border-collapse: collapse; }
    .records-table td { vertical-align: middle; }
    .record-filter-row { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; min-width: 160px; }
    .filters { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start; margin-top: 12px; }
    .filters .filter-group { min-width: 150px; display: flex; flex-direction: column; gap: 10px; }
    .filters .filter-id { flex: 1 1 220px; }
    .filters .filter-period { flex: 1 1 320px; }
    .filters .filter-label { font-weight: 700; color: #1e293b; font-size: 13px; letter-spacing: -0.01em; }
    .input-card { background: linear-gradient(145deg, #ecfeff, #cffafe); border: 1px solid #bae6fd; border-radius: 16px; padding: 16px 18px; box-shadow: 0 10px 22px rgba(14, 165, 233, 0.12); display: flex; flex-direction: column; gap: 10px; min-height: 118px; justify-content: center; }
    .input-card input[type="text"] { width: 100%; padding: 11px 12px; border: 1px solid #bae6fd; border-radius: 10px; background: rgba(255,255,255,0.92); font-size: 14px; font-weight: 500; color: #0f172a; transition: border 0.12s ease, box-shadow 0.12s ease; }
    .input-card input[type="text"]::placeholder { color: #94a3b8; }
    .input-card input[type="text"]:focus { outline: none; border-color: #0284c7; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.2); background: #fff; }
    .period-card { background: linear-gradient(145deg, #eef2ff, #e2e8ff); border: 1px solid #c7d2fe; border-radius: 16px; padding: 16px 18px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.12); min-height: 118px; justify-content: center; }
    .period-status { margin: 0; font-size: 13px; color: #1e293b; font-weight: 600; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .period-status span { font-size: 12px; color: #475569; font-weight: 500; }
    .period-status.has-value { color: #0f172a; }
    .period-controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch; }
    .period-field { flex: 1 1 150px; display: flex; flex-direction: column; gap: 6px; padding: 10px 12px; border-radius: 12px; border: 1px solid #c7d2fe; background: rgba(255, 255, 255, 0.9); box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.08); }
    .period-field label { font-size: 12px; font-weight: 600; color: #312e81; letter-spacing: 0.01em; }
    .period-field input { width: 100%; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #1d4ed8; padding: 0; height: 24px; }
    .period-field input:focus { outline: none; }
    .period-field input::-webkit-calendar-picker-indicator { filter: invert(21%) sepia(94%) saturate(3396%) hue-rotate(221deg) brightness(95%) contrast(97%); cursor: pointer; }
    .period-clear { flex: 0 0 auto; border: none; background: rgba(15, 23, 42, 0.07); color: #1f2937; padding: 9px 16px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: background 0.12s ease; }
    .period-clear:hover { background: rgba(15, 23, 42, 0.12); }
    .filter-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; align-items: center; }
    .filter-actions-left { display: flex; gap: 8px; }
    .filter-actions button { margin: 0; }
    .filter-hint { margin-top: 8px; font-size: 12px; color: #666; }
    #recordActions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    #recordActions label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      white-space: nowrap;
    }
    #recordActions button {
      font-size: 13px;
      padding: 7px 14px;
      white-space: nowrap;
    }
    #selectedCount {
      color: #666;
      font-size: 13px;
      white-space: nowrap;
    }
    details.section { margin: 20px 0; }
    details.section > summary { cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; }
    details.section > summary::-webkit-details-marker { display: none; }
    details.section > summary h3 { margin: 0; }
    details.section > summary::after { content: 'â–¼'; font-size: 12px; margin-left: 8px; color: #666; }
    details.section[open] > summary::after { content: 'â–²'; }
    .records-placeholder { padding: 20px; text-align: center; color: #666; }
    @media (max-width: 600px) {
      .records-table thead { display: none; }
      .records-table table { border-collapse: separate; border-spacing: 0 12px; }
      .records-table tbody { display: block; }
      .records-table tr {
        display: grid;
        grid-template-columns: 32px 1fr 88px;
        grid-template-areas:
          "select time photo"
          "select emp photo"
          "select name photo";
        gap: 4px 12px;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
      }
      .records-table td {
        border: none;
        padding: 0;
        font-size: 13px;
      }
      .records-table td.select-cell { grid-area: select; padding-top: 4px; }
      .records-table td.time-cell { grid-area: time; font-weight: 600; }
      .records-table td.emp-cell { grid-area: emp; }
      .records-table td.name-cell { grid-area: name; }
      .records-table td.photo-cell { grid-area: photo; text-align: center; }
      .photo-preview { height: 48px; }
      .section-header { flex-direction: row; align-items: center; }
      .section-header h3 { font-size: 18px; }
      .section-header-actions { gap: 6px; font-size: 11px; }
      .section-header-actions button { padding: 6px 8px; font-size: 11px; min-width: 0; }
      .records-table td.name-cell { display: none; }
      .emp-inline-name { display: inline-block; font-size: 13px; color: #555; }
      .record-filter-row { flex-direction: column; align-items: stretch; }
      #recordActions { gap: 8px; }
      #recordActions label { font-size: 12px; }
      #recordActions button { font-size: 12px; padding: 6px 10px; }
      #selectedCount { font-size: 12px; }
      .filter-group { width: 100%; }
      .filter-actions { flex-direction: column; align-items: stretch; gap: 10px; }
      .filter-actions-left { width: 100%; gap: 6px; }
      .filter-actions-left button { flex: 1 1 auto; }
      .filter-hint { font-size: 11px; }
      .filters { gap: 12px; }
      .filters .filter-id, .filters .filter-period { min-width: 0; flex: 1 1 100%; }
      .period-controls { width: 100%; }
      .period-field { flex: 1 1 calc(50% - 6px); }
      .period-clear { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í¼ -->
  <div id="loginForm" class="login-form">
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <div id="loginError" class="error hidden"></div>
    <div>
      <label>ë¹„ë°€ë²ˆí˜¸</label><br />
      <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
    </div>
    <button class="primary" onclick="login()">ë¡œê·¸ì¸</button>
  </div>

  <!-- ê´€ë¦¬ì í˜ì´ì§€ -->
  <div id="adminPanel" class="hidden">
    <div class="header">
      <h1>ì¶œí‡´ê·¼ ê´€ë¦¬ì í˜ì´ì§€</h1>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ë“±ë¡ ê¸°ë¡ ì¡°íšŒ -->
    <div class="section">
      <div class="section-header">
        <h3>ë“±ë¡ ê¸°ë¡ ì¡°íšŒ</h3>
        <div class="section-header-actions">
          <button onclick="confirmDownload('csv')">CSV ë‹¤ìš´ë¡œë“œ</button>
          <button onclick="confirmDownload('consent')">ë™ì˜ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
      <div class="filters">
        <div class="filter-group filter-id">
          <label class="filter-label" for="searchEmpId">ì‚¬ë²ˆ</label>
          <div class="input-card">
            <input type="text" id="searchEmpId" placeholder="ì‚¬ë²ˆ ì…ë ¥ (ì˜ˆ: 170200)" />
            <p style="margin: 0; font-size: 12px; color: #1e40af; font-weight: 500;">í•„ìš”ì‹œ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
          </div>
        </div>
        <div class="filter-group filter-period">
          <span class="filter-label">ê¸°ê°„</span>
          <div class="period-card">
            <p class="period-status" id="periodStatus">ì„ íƒëœ ê¸°ê°„ ì—†ìŒ</p>
            <div class="period-controls">
              <div class="period-field">
                <label for="dateFilter">ì¼ì ì„ íƒ</label>
                <input type="date" id="dateFilter" />
              </div>
              <div class="period-field">
                <label for="monthFilter">ì›” ì„ íƒ</label>
                <input type="month" id="monthFilter" />
              </div>
              <button type="button" class="period-clear" id="periodClearBtn">ê¸°ê°„ ì‚­ì œ</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-actions">
        <div class="filter-actions-left">
          <button class="primary" onclick="loadRecords()">ì¡°íšŒ</button>
          <button onclick="resetRecordFilters()">í•„í„° ì´ˆê¸°í™”</button>
        </div>
      </div>
      <p class="filter-hint">ì‚¬ë²ˆ ë˜ëŠ” ê¸°ê°„ì„ ì„ íƒí•œ ë’¤ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê¸°ê°„ì€ ì¼ / ì›” ì¤‘ í•œ ê°€ì§€ ë°©ì‹ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
      <div id="recordActions">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords(this)" />
          ì „ì²´ ì„ íƒ
        </label>
        <button class="danger" id="deleteSelectedBtn" onclick="deleteSelectedRecords()" disabled>ì„ íƒ ì‚­ì œ</button>
        <button class="danger" id="deleteAllBtn" onclick="deleteAllRecords()" disabled>ì „ì²´ ì‚­ì œ</button>
        <span id="selectedCount" style="color: #666;">0ê±´ ì„ íƒë¨</span>
      </div>
      <div id="recordsTable" class="records-placeholder">ì¡°íšŒ ì¡°ê±´ì„ ì„ íƒí•œ ë’¤ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>

    <!-- ê¸°ê¸° ì¬ë“±ë¡ ìš”ì²­ ê´€ë¦¬ -->
    <details class="section" id="deviceRequestsSection">
      <summary>
        <h3 style="display: inline;">ê¸°ê¸° ì¬ë“±ë¡ ìš”ì²­ ê´€ë¦¬</h3>
        <span id="deviceRequestBadge" class="pending-pill hidden">ëŒ€ê¸° 0ê±´</span>
      </summary>
      <div class="info-box">
        <strong>ì•ˆë‚´:</strong> ì‚¬ìš©ìê°€ ê¸°ê¸° ë³€ê²½ì„ ìš”ì²­í•œ ê²½ìš°, ìŠ¹ì¸í•˜ë©´ í•´ë‹¹ ì‚¬ë²ˆì˜ ëª¨ë“  ë“±ë¡ ê¸°ë¡ì˜ ê¸°ê¸° IDê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
      </div>
      <div style="margin: 15px 0;">
        <label>ìƒíƒœ í•„í„°</label>
        <select id="requestStatusFilter" onchange="loadDeviceRequests()">
          <option value="all">ì „ì²´</option>
          <option value="pending" selected>ëŒ€ê¸° ì¤‘</option>
          <option value="approved">ìŠ¹ì¸ë¨</option>
          <option value="rejected">ê±°ë¶€ë¨</option>
        </select>
        <button class="primary" onclick="loadDeviceRequests()">ìƒˆë¡œê³ ì¹¨</button>
        <span id="requestCount" style="margin-left: 10px; color: #666;"></span>
      </div>
      <div id="deviceRequestsTable"></div>
    </details>

    <!-- ê¸°ê¸° ID ì—…ë°ì´íŠ¸ -->
    <details class="section">
      <summary><h3 style="display: inline;">ê¸°ê¸° ID ì—…ë°ì´íŠ¸</h3></summary>
      <p>ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë“±ë¡ëœ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°, ìƒˆ ê¸°ê¸° IDë¡œ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div>
        <label>ì‚¬ë²ˆ</label>
        <input type="text" id="updateEmpId" placeholder="ì‚¬ë²ˆ ì…ë ¥" />
        <label>ìƒˆ ê¸°ê¸° ID</label>
        <input type="text" id="updateDeviceId" placeholder="ìƒˆ ê¸°ê¸° ID ì…ë ¥" />
        <button class="primary" onclick="updateDeviceId()">ê¸°ê¸° ID ì—…ë°ì´íŠ¸</button>
      </div>
      <div id="updateResult" class="hidden"></div>
    </details>
  </div>

  <script>
    let adminToken = localStorage.getItem('admin_token');
    let cachedRecords = [];
    const selectedRecordIds = new Set();
    let pendingRequestCount = 0;
    let pendingBadgeTimer = null;
    const deviceRequestsSection = document.getElementById('deviceRequestsSection');
    const deviceRequestBadge = document.getElementById('deviceRequestBadge');
    const dateFilterInput = document.getElementById('dateFilter');
    const monthFilterInput = document.getElementById('monthFilter');
    const periodStatus = document.getElementById('periodStatus');
    const periodClearBtn = document.getElementById('periodClearBtn');
    function formatDisplayDate(value, type) {
      if (!value) return '';
      if (type === 'month') {
        const [year, month] = value.split('-');
        return `${year}.${month}`;
      }
      const [year, month, day] = value.split('-');
      return `${year}.${month}.${day}`;
    }

    function updatePeriodStatus() {
      if (!periodStatus) return;
      const dateValue = dateFilterInput?.value;
      const monthValue = monthFilterInput?.value;
      let text = 'ì„ íƒëœ ê¸°ê°„ ì—†ìŒ';
      if (dateValue) {
        text = `ì„ íƒëœ ê¸°ê°„: ${formatDisplayDate(dateValue, 'date')} (ì¼ì)`;
      } else if (monthValue) {
        text = `ì„ íƒëœ ê¸°ê°„: ${formatDisplayDate(monthValue, 'month')} (ì›”)`;
      }
      periodStatus.textContent = text;
      periodStatus.classList.toggle('has-value', Boolean(dateValue || monthValue));
    }

    function clearPeriodSelection() {
      if (dateFilterInput) dateFilterInput.value = '';
      if (monthFilterInput) monthFilterInput.value = '';
      updatePeriodStatus();
    }

    if (dateFilterInput) {
      dateFilterInput.addEventListener('change', () => {
        if (dateFilterInput.value && monthFilterInput) {
          monthFilterInput.value = '';
        }
        onDateFilterChange();
        updatePeriodStatus();
      });
    }

    if (monthFilterInput) {
      monthFilterInput.addEventListener('change', () => {
        if (monthFilterInput.value && dateFilterInput) {
          dateFilterInput.value = '';
        }
        onMonthFilterChange();
        updatePeriodStatus();
      });
    }

    if (periodClearBtn) {
      periodClearBtn.addEventListener('click', () => {
        clearPeriodSelection();
      });
    }

    updatePeriodStatus();

    function updatePendingRequestBadge(count, options = {}) {
      const { alertOnIncrease = false } = options;
      if (!deviceRequestBadge) return;

      if (count > 0) {
        deviceRequestBadge.textContent = `ëŒ€ê¸° ${count}ê±´`;
        deviceRequestBadge.classList.remove('hidden');
        if (alertOnIncrease && count > pendingRequestCount) {
          showPendingRequestAlert(count);
        }
      } else {
        deviceRequestBadge.classList.add('hidden');
      }
      pendingRequestCount = count;
    }

    async function refreshPendingRequestBadge(options = {}) {
      if (!adminToken || !deviceRequestBadge) return;

      try {
        const res = await fetch('/api/admin/device-requests?status=pending', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'ì¡°íšŒ ì‹¤íŒ¨');

        const count = Array.isArray(data.requests) ? data.requests.length : 0;
        updatePendingRequestBadge(count, options);
      } catch (err) {
        console.error('pending request badge ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
      }
    }

    function showPendingRequestAlert(count) {
      if (deviceRequestsSection && !deviceRequestsSection.open) {
        deviceRequestsSection.open = true;
      }
      alert(`ğŸ“¬ ê¸°ê¸° ì¬ë“±ë¡ ìš”ì²­ì´ ${count}ê±´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.`);
    }

    function startPendingRequestWatcher() {
      if (pendingBadgeTimer) {
        clearInterval(pendingBadgeTimer);
      }
      refreshPendingRequestBadge({ alertOnIncrease: false });
      pendingBadgeTimer = setInterval(() => {
        refreshPendingRequestBadge({ alertOnIncrease: true });
      }, 60000);
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        refreshPendingRequestBadge({ alertOnIncrease: false });
      }
    });

    function confirmDownload(type) {
      if (type === 'csv') {
        if (confirm('CSV íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí• ê¹Œìš”?')) {
          downloadCSV();
        }
      } else if (type === 'consent') {
        if (confirm('ë™ì˜ ë¡œê·¸ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí• ê¹Œìš”?')) {
          downloadConsentLogs();
        }
      }
    }

    function setRecordsPlaceholder(message) {
      const tableDiv = document.getElementById('recordsTable');
      if (!tableDiv) return;
      tableDiv.className = 'records-placeholder';
      tableDiv.innerHTML = `<p class="records-placeholder">${message}</p>`;
    }

    function onDateFilterChange() {
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (dateInput && monthInput && dateInput.value) {
        monthInput.value = '';
      }
    }

    function onMonthFilterChange() {
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (dateInput && monthInput && monthInput.value) {
        dateInput.value = '';
      }
    }

    function resetRecordFilters() {
      const empInput = document.getElementById('searchEmpId');
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (empInput) empInput.value = '';
      if (dateInput) dateInput.value = '';
      if (monthInput) monthInput.value = '';
      clearPeriodSelection();
      updatePeriodStatus();
      cachedRecords = [];
      resetSelectionState();
      setRecordsPlaceholder('ì¡°íšŒ ì¡°ê±´ì„ ì„ íƒí•œ ë’¤ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
    if (adminToken) {
      checkAuth();
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function resetSelectionState() {
      selectedRecordIds.clear();
      const selectAll = document.getElementById('selectAllRecords');
      if (selectAll) selectAll.checked = false;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const countSpan = document.getElementById('selectedCount');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      const selectAll = document.getElementById('selectAllRecords');

      if (countSpan) countSpan.textContent = `${selectedRecordIds.size}ê±´ ì„ íƒë¨`;
      if (deleteBtn) deleteBtn.disabled = selectedRecordIds.size === 0;
      if (deleteAllBtn) deleteAllBtn.disabled = cachedRecords.length === 0;
      if (selectAll) {
        selectAll.checked = cachedRecords.length > 0 && selectedRecordIds.size === cachedRecords.length;
        selectAll.indeterminate = selectedRecordIds.size > 0 && selectedRecordIds.size < cachedRecords.length;
      }
    }


    function toggleRecordSelection(checkbox) {
      const recordId = Number(checkbox.dataset.id);
      if (checkbox.checked) {
        selectedRecordIds.add(recordId);
      } else {
        selectedRecordIds.delete(recordId);
      }
      updateSelectedCount();
    }

    function toggleAllRecords(checkbox) {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      if (checkbox.checked) {
        cachedRecords.forEach(record => selectedRecordIds.add(record.recordId));
        checkboxes.forEach(cb => cb.checked = true);
      } else {
        selectedRecordIds.clear();
        checkboxes.forEach(cb => cb.checked = false);
      }
      updateSelectedCount();
    }

    async function deleteSelectedRecords() {
      if (selectedRecordIds.size === 0) return;
      if (!confirm(`${selectedRecordIds.size}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ ì‚¬ì§„ íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ recordIds: Array.from(selectedRecordIds) })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`âœ… ${data.deleted}ê±´ ì‚­ì œ, ${data.deletedFiles}ê°œ íŒŒì¼ ì œê±°`);
          await loadRecords();
        } else {
          alert('âŒ ' + (data.message || 'ì‚­ì œ ì‹¤íŒ¨'));
        }
      } catch (e) {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ì„ íƒ ì‚­ì œ ì˜¤ë¥˜:', e);
      }
    }

    async function deleteAllRecords() {
      if (cachedRecords.length === 0) {
        alert('ì‚­ì œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      if (!confirm(`ì´ ${cachedRecords.length}ê±´ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ ì‚¬ì§„ íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ deleteAll: true })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`âœ… ì „ì²´ ì‚­ì œ ì™„ë£Œ (${data.deleted}ê±´, íŒŒì¼ ${data.deletedFiles}ê°œ ì œê±°)`);
          await loadRecords();
        } else {
          alert('âŒ ' + (data.message || 'ì „ì²´ ì‚­ì œ ì‹¤íŒ¨'));
        }
      } catch (e) {
        alert('ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ì „ì²´ ì‚­ì œ ì˜¤ë¥˜:', e);
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/admin/check', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          cachedRecords = [];
          resetSelectionState();
          setRecordsPlaceholder('ì¡°íšŒ ì¡°ê±´ì„ ì„ íƒí•œ ë’¤ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
          loadDeviceRequests();
          startPendingRequestWatcher();
        } else {
          logout();
        }
      } catch {
        logout();
      }
    }

    async function login() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!password) {
        errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        
        if (data.ok) {
          adminToken = data.token;
          localStorage.setItem('admin_token', adminToken);
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          errorDiv.classList.add('hidden');
          cachedRecords = [];
          resetSelectionState();
          setRecordsPlaceholder('ì¡°íšŒ ì¡°ê±´ì„ ì„ íƒí•œ ë’¤ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
          loadDeviceRequests();
          startPendingRequestWatcher();
        } else {
          errorDiv.textContent = data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
          errorDiv.classList.remove('hidden');
        }
      } catch (e) {
        errorDiv.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        errorDiv.classList.remove('hidden');
      }
    }

    function logout() {
      localStorage.removeItem('admin_token');
      adminToken = null;
      if (pendingBadgeTimer) {
        clearInterval(pendingBadgeTimer);
        pendingBadgeTimer = null;
      }
      pendingRequestCount = 0;
      if (deviceRequestBadge) {
        deviceRequestBadge.classList.add('hidden');
      }
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
    }

    async function loadRecords() {
      const empInput = document.getElementById('searchEmpId');
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      const empId = empInput ? empInput.value.trim() : '';
      const dateValue = dateInput ? dateInput.value : '';
      const monthValue = monthInput ? monthInput.value : '';

      if (dateValue && monthValue) {
        alert('ë‚ ì§œì™€ ì›”ì€ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!empId && !dateValue && !monthValue) {
        alert('ì‚¬ë²ˆ ë˜ëŠ” ë‚ ì§œ/ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const params = new URLSearchParams();
      if (empId) params.set('employeeId', empId);
      if (dateValue) params.set('date', dateValue);
      if (monthValue) params.set('month', monthValue);
      const queryString = params.toString();
      const url = `/api/admin/records${queryString ? `?${queryString}` : ''}`;
      setRecordsPlaceholder('ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          cachedRecords = data.records || [];
          displayRecords(cachedRecords);
        } else {
          cachedRecords = [];
          setRecordsPlaceholder(data.message ? `ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${data.message}` : 'ê¸°ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (e) {
        cachedRecords = [];
        setRecordsPlaceholder('ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        resetSelectionState();
      }
    }

    function displayRecords(records) {
      const tableDiv = document.getElementById('recordsTable');
      tableDiv.className = 'records-table';
      if (!records || records.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">ë“±ë¡ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        updateSelectedCount();
        return;
      }

      // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
      const formatTime = (timeStr, shortFormat = false) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          const pad = (n) => String(n).padStart(2, '0');
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          if (shortFormat) {
            return `${month}/${day}`;
          }
          const hour = pad(date.getHours());
          const minute = pad(date.getMinutes());
          const second = pad(date.getSeconds());
          return `${year}/${month}/${day} ${hour}:${minute}:${second}`;
        } catch {
          return timeStr;
        }
      };

      let html = '<table><thead><tr><th style="width: 42px;">ì„ íƒ</th><th>ì‹œê°„</th><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ì‚¬ì§„</th></tr></thead><tbody>';
      records.forEach(record => {
        const imageUrl = record.file || '';
        const hasImage = Boolean(imageUrl);
        const cleanupTime = record.photo_deleted_at
          ? 'ì‚¬ì§„ ì‚­ì œë¨'
          : record.cleanup_scheduled_at
            ? `ì‚­ì œ ì˜ˆì • ${formatTime(record.cleanup_scheduled_at, true)}`
            : 'ë³´ê´€ ì¤‘';
        const safeNameAttr = (record.name || '-').replace(/"/g, '&quot;');
        html += `<tr>
          <td class="select-cell">
            <input type="checkbox" class="record-checkbox" data-id="${record.recordId}" onchange="toggleRecordSelection(this)" />
          </td>
          <td class="time-cell">${formatTime(record.server_time)}</td>
          <td class="emp-cell"><strong>${record.employee_id || '-'}</strong><span class="emp-inline-name">${record.name || '-'}</span></td>
          <td class="name-cell">
            <span class="truncate" title="${safeNameAttr}">${record.name || '-'}</span>
          </td>
          <td class="photo-cell">
            ${hasImage ? `
              <div style="display: inline-flex; flex-direction: column; align-items: center;">
                <img src="${imageUrl}"
                     alt="ë¯¸ë¦¬ë³´ê¸°"
                     class="photo-preview"
                     onclick="showImageModal('${imageUrl}', 'ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°')" />
              </div>
            ` : '<span style="color: #999;">-</span>'}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
      updateSelectedCount();
    }

    // ì´ë¯¸ì§€ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    function showImageModal(imageUrl, fileName) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
      `;
      modal.onclick = () => {
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
      img.onclick = (e) => e.stopPropagation();
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'âœ•';
      closeBtn.style.cssText = `
        position: absolute; top: 20px; right: 20px;
        width: 40px; height: 40px; border-radius: 50%;
        background: rgba(255,255,255,0.9); border: none;
        font-size: 24px; cursor: pointer; color: #333;
        display: flex; align-items: center; justify-content: center;
      `;
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };
      
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
    }

    async function updateDeviceId() {
      const empId = document.getElementById('updateEmpId').value.trim();
      const newDeviceId = document.getElementById('updateDeviceId').value.trim();
      const resultDiv = document.getElementById('updateResult');
      
      if (!empId || !newDeviceId) {
        resultDiv.innerHTML = '<div class="error">ì‚¬ë²ˆê³¼ ìƒˆ ê¸°ê¸° IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
        resultDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/update-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ employeeId: empId, deviceId: newDeviceId })
        });
        const data = await res.json();
        
        if (data.ok) {
          resultDiv.innerHTML = `<div class="success">âœ… ê¸°ê¸° IDê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (${data.updated}ê°œ ê¸°ë¡ ì—…ë°ì´íŠ¸)</div>`;
          resultDiv.classList.remove('hidden');
          loadRecords(); // ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          resultDiv.innerHTML = `<div class="error">âŒ ${data.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨'}</div>`;
          resultDiv.classList.remove('hidden');
        }
      } catch (e) {
        resultDiv.innerHTML = '<div class="error">ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        resultDiv.classList.remove('hidden');
      }
    }

    async function downloadCSV() {
      try {
        const res = await fetch('/api/admin/download-csv', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          alert('CSV ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
        }
      } catch (e) {
        alert('CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function downloadConsentLogs() {
      try {
        const res = await fetch('/api/admin/download-consent-logs', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.status === 204) {
          alert('ì €ì¥ëœ ë™ì˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `consent_logs_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          const data = await res.json().catch(() => ({}));
          alert('ë™ì˜ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        alert('ë™ì˜ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('download consent logs error:', e);
      }
    }

    // ê¸°ê¸° ì¬ë“±ë¡ ìš”ì²­ ëª©ë¡ ì¡°íšŒ
    async function loadDeviceRequests() {
      const status = document.getElementById('requestStatusFilter').value;
      const url = `/api/admin/device-requests?status=${status}`;
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          displayDeviceRequests(data.requests);
          if (status === 'pending') {
            updatePendingRequestBadge(Array.isArray(data.requests) ? data.requests.length : 0, { alertOnIncrease: false });
          } else {
            await refreshPendingRequestBadge({ alertOnIncrease: false });
          }
        } else {
          alert('ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        alert('ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ê¸°ê¸° ì¬ë“±ë¡ ìš”ì²­ ëª©ë¡ í‘œì‹œ
    function displayDeviceRequests(requests) {
      const tableDiv = document.getElementById('deviceRequestsTable');
      const countSpan = document.getElementById('requestCount');
      
      if (!requests || requests.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        countSpan.textContent = '';
        return;
      }

      // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
      const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          return date.toLocaleString('ko-KR', { 
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return timeStr;
        }
      };

      countSpan.textContent = `ì´ ${requests.length}ê±´`;
      
      let html = '<table><thead><tr><th>ìš”ì²­ì¼ì‹œ</th><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ê¸°ê¸° ID</th><th>ìƒíƒœ</th><th>ì²˜ë¦¬ì¼ì‹œ</th><th>ì‘ì—…</th></tr></thead><tbody>';
      requests.forEach(req => {
        const statusClass = req.status === 'pending' ? 'status-pending' : 
                           req.status === 'approved' ? 'status-approved' : 
                           'status-rejected';
        const statusText = req.status === 'pending' ? 'â³ ëŒ€ê¸°' : 
                          req.status === 'approved' ? 'âœ… ìŠ¹ì¸' : 
                          'âŒ ê±°ë¶€';
        const processTime = formatTime(req.approvedAt || req.rejectedAt);
        const actions = req.status === 'pending' ? 
          `<button class="primary" onclick="approveRequest('${req.id}')">ìŠ¹ì¸</button>
           <button class="danger" onclick="rejectRequest('${req.id}')">ê±°ë¶€</button>` : 
          '-';
        
        html += `<tr>
          <td>${formatTime(req.requestedAt)}</td>
          <td><strong>${req.employeeId || '-'}</strong></td>
          <td>${req.name || '-'}</td>
          <td style="font-size: 0.85em; word-break: break-all; max-width: 200px;">${req.deviceId || '-'}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${processTime}</td>
          <td>${actions}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    // ìš”ì²­ ìŠ¹ì¸
    async function approveRequest(requestId) {
      if (!confirm('ì´ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìŠ¹ì¸í•˜ë©´ í•´ë‹¹ ì‚¬ë²ˆì˜ ëª¨ë“  ë“±ë¡ ê¸°ë¡ì˜ ê¸°ê¸° IDê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/approve-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert(`âœ… ìŠ¹ì¸ ì™„ë£Œ (${data.updated}ê°œ ê¸°ë¡ ì—…ë°ì´íŠ¸)`);
          loadDeviceRequests();
          loadRecords(); // ë“±ë¡ ê¸°ë¡ë„ ìƒˆë¡œê³ ì¹¨
        } else {
          alert('âŒ ' + (data.message || 'ìŠ¹ì¸ ì‹¤íŒ¨'));
        }
      } catch (e) {
        alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ìŠ¹ì¸ ì˜¤ë¥˜:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }

    // ìš”ì²­ ê±°ë¶€
    async function rejectRequest(requestId) {
      if (!confirm('ì´ ìš”ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/reject-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('âœ… ê±°ë¶€ ì™„ë£Œ');
          loadDeviceRequests();
        } else {
          alert('âŒ ' + (data.message || 'ê±°ë¶€ ì‹¤íŒ¨'));
        }
      } catch (e) {
        alert('ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ê±°ë¶€ ì˜¤ë¥˜:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }
  </script>
</body>
</html>

