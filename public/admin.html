<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>관리자 페이지 - 출퇴근 관리</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
    .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .section h3 { margin-top: 0; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; font-weight: bold; color: #495057; }
    tr:hover { background-color: #f9f9f9; }
    button { padding: 8px 16px; margin: 4px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff; transition: all 0.2s; }
    button:hover { background: #f0f0f0; transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.primary { background: #007bff; color: white; border-color: #007bff; }
    button.primary:hover { background: #0056b3; }
    button.danger { background: #dc3545; color: white; border-color: #dc3545; }
    button.danger:hover { background: #c82333; }
    input, select { padding: 8px; margin: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
    .login-form { max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .error { color: #dc3545; margin: 10px 0; padding: 8px; background: #f8d7da; border-radius: 4px; }
    .success { color: #28a745; margin: 10px 0; padding: 8px; background: #d4edda; border-radius: 4px; }
    .hidden { display: none; }
    .info-box { padding: 12px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px; margin: 10px 0; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .loading { opacity: 0.6; pointer-events: none; }
    .photo-preview { max-width: 100px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
    .photo-preview:hover { transform: scale(1.05); }
  </style>
</head>
<body>
  <!-- 로그인 폼 -->
  <div id="loginForm" class="login-form">
    <h2>관리자 로그인</h2>
    <div id="loginError" class="error hidden"></div>
    <div>
      <label>비밀번호</label><br />
      <input type="password" id="adminPassword" placeholder="관리자 비밀번호" />
    </div>
    <button class="primary" onclick="login()">로그인</button>
  </div>

  <!-- 관리자 페이지 -->
  <div id="adminPanel" class="hidden">
    <div class="header">
      <h1>출퇴근 관리자 페이지</h1>
      <button onclick="logout()">로그아웃</button>
    </div>

    <!-- 관리자 비밀번호 변경 -->
    <div class="section">
      <h3>관리자 비밀번호 변경</h3>
      <p>현재 비밀번호 확인 후 바로 새 비밀번호로 변경할 수 있습니다. 새 비밀번호는 최소 8자 이상으로 설정해주세요.</p>
      <div id="passwordChangeMessage" class="hidden"></div>
      <div>
        <label>현재 비밀번호</label>
        <input type="password" id="currentAdminPassword" placeholder="현재 비밀번호" autocomplete="current-password" />
      </div>
      <div>
        <label>새 비밀번호</label>
        <input type="password" id="newAdminPassword" placeholder="새 비밀번호 (8자 이상)" autocomplete="new-password" />
      </div>
      <div>
        <label>새 비밀번호 확인</label>
        <input type="password" id="confirmAdminPassword" placeholder="새 비밀번호 확인" autocomplete="new-password" />
      </div>
      <button class="primary" id="changePasswordBtn" onclick="changeAdminPassword()">비밀번호 변경</button>
    </div>

    <!-- 기기 ID 업데이트 -->
    <div class="section">
      <h3>기기 ID 업데이트</h3>
      <p>다른 기기에서 등록된 기록이 있는 경우, 새 기기 ID로 업데이트할 수 있습니다.</p>
      <div>
        <label>사번</label>
        <input type="text" id="updateEmpId" placeholder="사번 입력" />
        <label>새 기기 ID</label>
        <input type="text" id="updateDeviceId" placeholder="새 기기 ID 입력" />
        <button class="primary" onclick="updateDeviceId()">기기 ID 업데이트</button>
      </div>
      <div id="updateResult" class="hidden"></div>
    </div>

    <!-- 기기 재등록 요청 관리 -->
    <div class="section">
      <h3>기기 재등록 요청 관리</h3>
      <div class="info-box">
        <strong>안내:</strong> 사용자가 기기 변경을 요청한 경우, 승인하면 해당 사번의 모든 등록 기록의 기기 ID가 업데이트됩니다.
      </div>
      <div style="margin: 15px 0;">
        <label>상태 필터</label>
        <select id="requestStatusFilter" onchange="loadDeviceRequests()">
          <option value="all">전체</option>
          <option value="pending" selected>대기 중</option>
          <option value="approved">승인됨</option>
          <option value="rejected">거부됨</option>
        </select>
        <button class="primary" onclick="loadDeviceRequests()">새로고침</button>
        <span id="requestCount" style="margin-left: 10px; color: #666;"></span>
      </div>
      <div id="deviceRequestsTable"></div>
    </div>

    <!-- 등록 기록 조회 -->
    <div class="section">
      <h3>등록 기록 조회</h3>
      <div>
        <label>사번으로 검색</label>
        <input type="text" id="searchEmpId" placeholder="사번 (전체 조회는 비워두세요)" />
        <button class="primary" onclick="loadRecords()">조회</button>
        <button onclick="downloadCSV()">CSV 다운로드</button>
      </div>
      <div id="recordActions" style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords(this)" />
          전체 선택
        </label>
        <button class="danger" id="deleteSelectedBtn" onclick="deleteSelectedRecords()" disabled>선택 삭제</button>
        <button class="danger" id="deleteAllBtn" onclick="deleteAllRecords()" disabled>전체 삭제</button>
        <span id="selectedCount" style="color: #666;">0건 선택됨</span>
      </div>
      <div id="recordsTable"></div>
    </div>
  </div>

  <script>
    let adminToken = localStorage.getItem('admin_token');
    let cachedRecords = [];
    const selectedRecordIds = new Set();

    // 페이지 로드 시 토큰 확인
    if (adminToken) {
      checkAuth();
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function resetSelectionState() {
      selectedRecordIds.clear();
      const selectAll = document.getElementById('selectAllRecords');
      if (selectAll) selectAll.checked = false;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const countSpan = document.getElementById('selectedCount');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      const selectAll = document.getElementById('selectAllRecords');

      if (countSpan) countSpan.textContent = `${selectedRecordIds.size}건 선택됨`;
      if (deleteBtn) deleteBtn.disabled = selectedRecordIds.size === 0;
      if (deleteAllBtn) deleteAllBtn.disabled = cachedRecords.length === 0;
      if (selectAll) {
        selectAll.checked = cachedRecords.length > 0 && selectedRecordIds.size === cachedRecords.length;
        selectAll.indeterminate = selectedRecordIds.size > 0 && selectedRecordIds.size < cachedRecords.length;
      }
    }

    function clearPasswordChangeMessage() {
      const box = document.getElementById('passwordChangeMessage');
      if (!box) return;
      box.textContent = '';
      box.classList.add('hidden');
      box.classList.remove('error', 'success');
    }

    function setPasswordChangeMessage(type, message) {
      const box = document.getElementById('passwordChangeMessage');
      if (!box) return;
      box.textContent = message;
      box.classList.remove('hidden', 'error', 'success');
      box.classList.add(type === 'success' ? 'success' : 'error');
    }

    async function changeAdminPassword() {
      const currentInput = document.getElementById('currentAdminPassword');
      const newInput = document.getElementById('newAdminPassword');
      const confirmInput = document.getElementById('confirmAdminPassword');
      const submitBtn = document.getElementById('changePasswordBtn');

      const currentPassword = currentInput.value;
      const newPassword = newInput.value;
      const confirmPassword = confirmInput.value;

      clearPasswordChangeMessage();

      if (!currentPassword || !newPassword || !confirmPassword) {
        setPasswordChangeMessage('error', '모든 입력 칸을 채워주세요.');
        return;
      }

      if (newPassword.length < 8) {
        setPasswordChangeMessage('error', '새 비밀번호는 최소 8자 이상이어야 합니다.');
        return;
      }

      if (newPassword !== confirmPassword) {
        setPasswordChangeMessage('error', '새 비밀번호가 서로 일치하지 않습니다.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.classList.add('loading');

      try {
        const res = await fetch('/api/admin/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
        });

        const data = await res.json();

        if (res.status === 401) {
          alert('인증이 만료되었거나 권한이 없습니다. 다시 로그인해주세요.');
          logout();
          return;
        }

        if (data.ok) {
          setPasswordChangeMessage('success', data.message || '비밀번호가 변경되었습니다.');
          currentInput.value = '';
          newInput.value = '';
          confirmInput.value = '';
        } else {
          setPasswordChangeMessage('error', data.message || '비밀번호 변경에 실패했습니다.');
        }
      } catch (err) {
        console.error('change password error:', err);
        setPasswordChangeMessage('error', '비밀번호 변경 중 오류가 발생했습니다.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
      }
    }

    function toggleRecordSelection(checkbox) {
      const recordId = Number(checkbox.dataset.id);
      if (checkbox.checked) {
        selectedRecordIds.add(recordId);
      } else {
        selectedRecordIds.delete(recordId);
      }
      updateSelectedCount();
    }

    function toggleAllRecords(checkbox) {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      if (checkbox.checked) {
        cachedRecords.forEach(record => selectedRecordIds.add(record.recordId));
        checkboxes.forEach(cb => cb.checked = true);
      } else {
        selectedRecordIds.clear();
        checkboxes.forEach(cb => cb.checked = false);
      }
      updateSelectedCount();
    }

    async function deleteSelectedRecords() {
      if (selectedRecordIds.size === 0) return;
      if (!confirm(`${selectedRecordIds.size}개의 기록을 삭제하시겠습니까?\n관련 사진 파일도 함께 삭제됩니다.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ recordIds: Array.from(selectedRecordIds) })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`✅ ${data.deleted}건 삭제, ${data.deletedFiles}개 파일 제거`);
          await loadRecords();
        } else {
          alert('❌ ' + (data.message || '삭제 실패'));
        }
      } catch (e) {
        alert('삭제 중 오류가 발생했습니다.');
        console.error('선택 삭제 오류:', e);
      }
    }

    async function deleteAllRecords() {
      if (cachedRecords.length === 0) {
        alert('삭제할 기록이 없습니다.');
        return;
      }
      if (!confirm(`총 ${cachedRecords.length}건의 모든 기록을 삭제하시겠습니까?\n관련 사진 파일도 함께 삭제됩니다.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ deleteAll: true })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`✅ 전체 삭제 완료 (${data.deleted}건, 파일 ${data.deletedFiles}개 제거)`);
          await loadRecords();
        } else {
          alert('❌ ' + (data.message || '전체 삭제 실패'));
        }
      } catch (e) {
        alert('전체 삭제 중 오류가 발생했습니다.');
        console.error('전체 삭제 오류:', e);
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/admin/check', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          loadRecords();
          loadDeviceRequests();
        } else {
          logout();
        }
      } catch {
        logout();
      }
    }

    async function login() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!password) {
        errorDiv.textContent = '비밀번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        
        if (data.ok) {
          adminToken = data.token;
          localStorage.setItem('admin_token', adminToken);
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          errorDiv.classList.add('hidden');
          loadRecords();
          loadDeviceRequests();
        } else {
          errorDiv.textContent = data.message || '로그인 실패';
          errorDiv.classList.remove('hidden');
        }
      } catch (e) {
        errorDiv.textContent = '로그인 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    function logout() {
      localStorage.removeItem('admin_token');
      adminToken = null;
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
      const currentInput = document.getElementById('currentAdminPassword');
      const newInput = document.getElementById('newAdminPassword');
      const confirmInput = document.getElementById('confirmAdminPassword');
      if (currentInput) currentInput.value = '';
      if (newInput) newInput.value = '';
      if (confirmInput) confirmInput.value = '';
      clearPasswordChangeMessage();
    }

    async function loadRecords() {
      const empId = document.getElementById('searchEmpId').value.trim();
      const url = empId ? `/api/admin/records?employeeId=${empId}` : '/api/admin/records';
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          cachedRecords = data.records || [];
          displayRecords(cachedRecords);
        } else {
          alert('기록 조회 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (e) {
        alert('기록 조회 중 오류가 발생했습니다.');
      } finally {
        resetSelectionState();
      }
    }

    function displayRecords(records) {
      const tableDiv = document.getElementById('recordsTable');
      if (!records || records.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">등록 기록이 없습니다.</p>';
        updateSelectedCount();
        return;
      }

      // 시간 포맷팅 함수
      const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          return date.toLocaleString('ko-KR', { 
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
        } catch {
          return timeStr;
        }
      };

      let html = '<table><thead><tr><th style="width: 42px;">선택</th><th>시간</th><th>사번</th><th>이름</th><th>IP</th><th>기기 ID</th><th>사내망</th><th>사진</th><th>작업</th></tr></thead><tbody>';
      records.forEach(record => {
        const imageUrl = record.file || '';
        const hasImage = Boolean(imageUrl);
        let displayFile = '-';
        if (imageUrl) {
          try {
            const parts = imageUrl.split('/');
            displayFile = decodeURIComponent(parts[parts.length - 1] || imageUrl).slice(-100);
          } catch {
            displayFile = imageUrl.slice(-100);
          }
        }
        
        html += `<tr>
          <td><input type="checkbox" class="record-checkbox" data-id="${record.recordId}" onchange="toggleRecordSelection(this)" /></td>
          <td>${formatTime(record.server_time)}</td>
          <td><strong>${record.employee_id || '-'}</strong></td>
          <td>${record.name || '-'}</td>
          <td style="font-family: monospace;">${record.ip || '-'}</td>
          <td style="font-size: 0.85em; word-break: break-all; max-width: 200px;">${record.device_id || '-'}</td>
          <td>${record.office ? '<span style="color: green;">✅</span>' : '<span style="color: red;">❌</span>'}</td>
          <td>
            ${hasImage ? `
              <div style="position: relative; display: inline-block;">
                <img src="${imageUrl}" 
                     alt="미리보기" 
                     class="photo-preview"
                     onclick="showImageModal('${imageUrl}', '${displayFile.replace(/'/g, "\\'")}')" />
                <div style="margin-top: 4px; font-size: 0.85em; color: #666; max-width: 180px; word-break: break-all;">${displayFile}</div>
              </div>
            ` : '<span style="color: #999;">-</span>'}
          </td>
          <td>
            ${hasImage ? `
              <button class="danger" onclick="deletePhoto(${record.recordId}, '${(record.employee_id || '').replace(/'/g, "\\'")}')" 
                      style="padding: 4px 8px; font-size: 12px;">사진 삭제</button>
            ` : '-'}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
      updateSelectedCount();
    }

    // 이미지 모달 표시 함수
    function showImageModal(imageUrl, fileName) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
      `;
      modal.onclick = () => document.body.removeChild(modal);
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
      img.onclick = (e) => e.stopPropagation();
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '✕';
      closeBtn.style.cssText = `
        position: absolute; top: 20px; right: 20px;
        width: 40px; height: 40px; border-radius: 50%;
        background: rgba(255,255,255,0.9); border: none;
        font-size: 24px; cursor: pointer; color: #333;
        display: flex; align-items: center; justify-content: center;
      `;
      closeBtn.onclick = () => document.body.removeChild(modal);
      
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
    }

    // 사진 삭제 함수
    async function deletePhoto(recordId, employeeId) {
      if (!confirm(`이 사진을 삭제하시겠습니까?\n\n사번: ${employeeId || '-'}\n\n삭제된 사진은 복구할 수 없습니다.`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/delete-photo', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ recordId })
        });
        
        const data = await res.json();
        
        if (data.ok) {
          alert('✅ 사진이 삭제되었습니다.');
          loadRecords(); // 목록 새로고침
        } else {
          alert('❌ ' + (data.message || '삭제 실패'));
        }
      } catch (e) {
        alert('삭제 중 오류가 발생했습니다.');
        console.error('삭제 오류:', e);
      }
    }

    async function updateDeviceId() {
      const empId = document.getElementById('updateEmpId').value.trim();
      const newDeviceId = document.getElementById('updateDeviceId').value.trim();
      const resultDiv = document.getElementById('updateResult');
      
      if (!empId || !newDeviceId) {
        resultDiv.innerHTML = '<div class="error">사번과 새 기기 ID를 모두 입력해주세요.</div>';
        resultDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/update-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ employeeId: empId, deviceId: newDeviceId })
        });
        const data = await res.json();
        
        if (data.ok) {
          resultDiv.innerHTML = `<div class="success">✅ 기기 ID가 성공적으로 업데이트되었습니다. (${data.updated}개 기록 업데이트)</div>`;
          resultDiv.classList.remove('hidden');
          loadRecords(); // 기록 새로고침
        } else {
          resultDiv.innerHTML = `<div class="error">❌ ${data.message || '업데이트 실패'}</div>`;
          resultDiv.classList.remove('hidden');
        }
      } catch (e) {
        resultDiv.innerHTML = '<div class="error">업데이트 중 오류가 발생했습니다.</div>';
        resultDiv.classList.remove('hidden');
      }
    }

    async function downloadCSV() {
      try {
        const res = await fetch('/api/admin/download-csv', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          alert('CSV 다운로드 실패');
        }
      } catch (e) {
        alert('CSV 다운로드 중 오류가 발생했습니다.');
      }
    }

    // 기기 재등록 요청 목록 조회
    async function loadDeviceRequests() {
      const status = document.getElementById('requestStatusFilter').value;
      const url = `/api/admin/device-requests?status=${status}`;
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          displayDeviceRequests(data.requests);
        } else {
          alert('요청 목록 조회 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (e) {
        alert('요청 목록 조회 중 오류가 발생했습니다.');
      }
    }

    // 기기 재등록 요청 목록 표시
    function displayDeviceRequests(requests) {
      const tableDiv = document.getElementById('deviceRequestsTable');
      const countSpan = document.getElementById('requestCount');
      
      if (!requests || requests.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">요청이 없습니다.</p>';
        countSpan.textContent = '';
        return;
      }

      // 시간 포맷팅 함수
      const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          return date.toLocaleString('ko-KR', { 
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return timeStr;
        }
      };

      countSpan.textContent = `총 ${requests.length}건`;
      
      let html = '<table><thead><tr><th>요청일시</th><th>사번</th><th>이름</th><th>기기 ID</th><th>상태</th><th>처리일시</th><th>작업</th></tr></thead><tbody>';
      requests.forEach(req => {
        const statusClass = req.status === 'pending' ? 'status-pending' : 
                           req.status === 'approved' ? 'status-approved' : 
                           'status-rejected';
        const statusText = req.status === 'pending' ? '⏳ 대기' : 
                          req.status === 'approved' ? '✅ 승인' : 
                          '❌ 거부';
        const processTime = formatTime(req.approvedAt || req.rejectedAt);
        const actions = req.status === 'pending' ? 
          `<button class="primary" onclick="approveRequest('${req.id}')">승인</button>
           <button class="danger" onclick="rejectRequest('${req.id}')">거부</button>` : 
          '-';
        
        html += `<tr>
          <td>${formatTime(req.requestedAt)}</td>
          <td><strong>${req.employeeId || '-'}</strong></td>
          <td>${req.name || '-'}</td>
          <td style="font-size: 0.85em; word-break: break-all; max-width: 200px;">${req.deviceId || '-'}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${processTime}</td>
          <td>${actions}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    // 요청 승인
    async function approveRequest(requestId) {
      if (!confirm('이 요청을 승인하시겠습니까? 승인하면 해당 사번의 모든 등록 기록의 기기 ID가 업데이트됩니다.')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/approve-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert(`✅ 승인 완료 (${data.updated}개 기록 업데이트)`);
          loadDeviceRequests();
          loadRecords(); // 등록 기록도 새로고침
        } else {
          alert('❌ ' + (data.message || '승인 실패'));
        }
      } catch (e) {
        alert('승인 처리 중 오류가 발생했습니다.');
        console.error('승인 오류:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }

    // 요청 거부
    async function rejectRequest(requestId) {
      if (!confirm('이 요청을 거부하시겠습니까?')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/reject-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('✅ 거부 완료');
          loadDeviceRequests();
        } else {
          alert('❌ ' + (data.message || '거부 실패'));
        }
      } catch (e) {
        alert('거부 처리 중 오류가 발생했습니다.');
        console.error('거부 오류:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }
  </script>
</body>
</html>

