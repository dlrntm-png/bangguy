<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>관리자 페이지 - 출퇴근 관리</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
    .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .section h3 { margin-top: 0; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; font-weight: bold; color: #495057; }
    tr:hover { background-color: #f9f9f9; }
    button { padding: 8px 16px; margin: 4px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff; transition: all 0.2s; }
    button:hover { background: #f0f0f0; transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.primary { background: #007bff; color: white; border-color: #007bff; }
    button.primary:hover { background: #0056b3; }
    button.danger { background: #dc3545; color: white; border-color: #dc3545; }
    button.danger:hover { background: #c82333; }
    input, select { padding: 8px; margin: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
    .login-form { max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .error { color: #dc3545; margin: 10px 0; padding: 8px; background: #f8d7da; border-radius: 4px; }
    .success { color: #28a745; margin: 10px 0; padding: 8px; background: #d4edda; border-radius: 4px; }
    .hidden { display: none; }
    .info-box { padding: 12px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px; margin: 10px 0; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .loading { opacity: 0.6; pointer-events: none; }
    .photo-preview { max-width: 90px; max-height: 90px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: transform 0.2s; display: block; }
    .photo-preview:hover { transform: scale(1.05); }
    .truncate { max-width: 120px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
    .name-cell { max-width: 120px; }
    .records-table table { width: 100%; border-collapse: collapse; }
    .records-table td { vertical-align: middle; }
    .status-wrapper { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; }
    .status-time { font-size: 12px; color: #666; }
    .record-filter-row { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; min-width: 160px; }
    .filter-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .filter-actions button { margin: 0; }
    .filter-hint { margin-top: 8px; font-size: 12px; color: #666; }
    details.section { margin: 20px 0; }
    details.section > summary { cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; }
    details.section > summary::-webkit-details-marker { display: none; }
    details.section > summary h3 { margin: 0; }
    details.section > summary::after { content: '▼'; font-size: 12px; margin-left: 8px; color: #666; }
    details.section[open] > summary::after { content: '▲'; }
    .records-placeholder { padding: 20px; text-align: center; color: #666; }
    @media (max-width: 600px) {
      .records-table thead { display: none; }
      .records-table table { border-collapse: separate; border-spacing: 0 12px; }
      .records-table tbody { display: block; }
      .records-table tr {
        display: grid;
        grid-template-columns: 32px 1fr 88px;
        grid-template-areas:
          "select time photo"
          "select emp photo"
          "select name photo"
          "select status photo";
        gap: 4px 12px;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
      }
      .records-table td {
        border: none;
        padding: 0;
        font-size: 13px;
      }
      .records-table td.select-cell { grid-area: select; padding-top: 4px; }
      .records-table td.time-cell { grid-area: time; font-weight: 600; }
      .records-table td.emp-cell { grid-area: emp; }
      .records-table td.name-cell { grid-area: name; }
      .records-table td.photo-cell { grid-area: photo; text-align: center; }
      .records-table td.status-cell { grid-area: status; margin-top: 6px; }
      .photo-preview { max-width: 72px; max-height: 72px; }
      .photo-meta { display: none; }
      .status-wrapper { gap: 4px; }
      .record-filter-row { flex-direction: column; align-items: stretch; }
      .filter-group { width: 100%; }
      .filter-actions { flex-direction: column; align-items: stretch; }
      .filter-actions button { width: 100%; }
      .filter-hint { font-size: 11px; }
    }
  </style>
</head>
<body>
  <!-- 로그인 폼 -->
  <div id="loginForm" class="login-form">
    <h2>관리자 로그인</h2>
    <div id="loginError" class="error hidden"></div>
    <div>
      <label>비밀번호</label><br />
      <input type="password" id="adminPassword" placeholder="관리자 비밀번호" />
    </div>
    <button class="primary" onclick="login()">로그인</button>
  </div>

  <!-- 관리자 페이지 -->
  <div id="adminPanel" class="hidden">
    <div class="header">
      <h1>출퇴근 관리자 페이지</h1>
      <button onclick="logout()">로그아웃</button>
    </div>

    <!-- 등록 기록 조회 -->
    <div class="section">
      <h3>등록 기록 조회</h3>
      <div class="record-filter-row">
        <div class="filter-group">
          <label for="searchEmpId">사번으로 검색</label>
          <input type="text" id="searchEmpId" placeholder="사번 입력" />
        </div>
        <div class="filter-group">
          <label for="dateFilter">날짜별 조회</label>
          <input type="date" id="dateFilter" onchange="onDateFilterChange()" />
        </div>
        <div class="filter-group">
          <label for="monthFilter">월별 조회</label>
          <input type="month" id="monthFilter" onchange="onMonthFilterChange()" />
        </div>
      </div>
      <div class="filter-actions">
        <button class="primary" onclick="loadRecords()">조회</button>
        <button onclick="resetRecordFilters()">필터 초기화</button>
        <button onclick="downloadCSV()">CSV 다운로드</button>
        <button onclick="downloadConsentLogs()">동의 로그 다운로드</button>
      </div>
      <p class="filter-hint">사번, 날짜 또는 월을 선택한 후 조회 버튼을 눌러주세요. 날짜와 월은 동시에 선택할 수 없습니다.</p>
      <div id="recordActions" style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords(this)" />
          전체 선택
        </label>
        <button class="danger" id="deleteSelectedBtn" onclick="deleteSelectedRecords()" disabled>선택 삭제</button>
        <button class="danger" id="deleteAllBtn" onclick="deleteAllRecords()" disabled>전체 삭제</button>
        <span id="selectedCount" style="color: #666;">0건 선택됨</span>
      </div>
      <div id="recordsTable" class="records-placeholder">조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.</div>
    </div>

    <!-- 기기 ID 업데이트 -->
    <details class="section">
      <summary><h3 style="display: inline;">기기 ID 업데이트</h3></summary>
      <p>다른 기기에서 등록된 기록이 있는 경우, 새 기기 ID로 업데이트할 수 있습니다.</p>
      <div>
        <label>사번</label>
        <input type="text" id="updateEmpId" placeholder="사번 입력" />
        <label>새 기기 ID</label>
        <input type="text" id="updateDeviceId" placeholder="새 기기 ID 입력" />
        <button class="primary" onclick="updateDeviceId()">기기 ID 업데이트</button>
      </div>
      <div id="updateResult" class="hidden"></div>
    </details>

    <!-- 기기 재등록 요청 관리 -->
    <details class="section">
      <summary><h3 style="display: inline;">기기 재등록 요청 관리</h3></summary>
      <div class="info-box">
        <strong>안내:</strong> 사용자가 기기 변경을 요청한 경우, 승인하면 해당 사번의 모든 등록 기록의 기기 ID가 업데이트됩니다.
      </div>
      <div style="margin: 15px 0;">
        <label>상태 필터</label>
        <select id="requestStatusFilter" onchange="loadDeviceRequests()">
          <option value="all">전체</option>
          <option value="pending" selected>대기 중</option>
          <option value="approved">승인됨</option>
          <option value="rejected">거부됨</option>
        </select>
        <button class="primary" onclick="loadDeviceRequests()">새로고침</button>
        <span id="requestCount" style="margin-left: 10px; color: #666;"></span>
      </div>
      <div id="deviceRequestsTable"></div>
    </details>
  </div>

  <script>
    let adminToken = localStorage.getItem('admin_token');
    let cachedRecords = [];
    const selectedRecordIds = new Set();

    function setRecordsPlaceholder(message) {
      const tableDiv = document.getElementById('recordsTable');
      if (!tableDiv) return;
      tableDiv.className = 'records-placeholder';
      tableDiv.innerHTML = `<p class="records-placeholder">${message}</p>`;
    }

    function onDateFilterChange() {
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (dateInput && monthInput && dateInput.value) {
        monthInput.value = '';
      }
    }

    function onMonthFilterChange() {
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (dateInput && monthInput && monthInput.value) {
        dateInput.value = '';
      }
    }

    function resetRecordFilters() {
      const empInput = document.getElementById('searchEmpId');
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      if (empInput) empInput.value = '';
      if (dateInput) dateInput.value = '';
      if (monthInput) monthInput.value = '';
      cachedRecords = [];
      resetSelectionState();
      setRecordsPlaceholder('조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.');
    }

    // 페이지 로드 시 토큰 확인
    if (adminToken) {
      checkAuth();
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function resetSelectionState() {
      selectedRecordIds.clear();
      const selectAll = document.getElementById('selectAllRecords');
      if (selectAll) selectAll.checked = false;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const countSpan = document.getElementById('selectedCount');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      const selectAll = document.getElementById('selectAllRecords');

      if (countSpan) countSpan.textContent = `${selectedRecordIds.size}건 선택됨`;
      if (deleteBtn) deleteBtn.disabled = selectedRecordIds.size === 0;
      if (deleteAllBtn) deleteAllBtn.disabled = cachedRecords.length === 0;
      if (selectAll) {
        selectAll.checked = cachedRecords.length > 0 && selectedRecordIds.size === cachedRecords.length;
        selectAll.indeterminate = selectedRecordIds.size > 0 && selectedRecordIds.size < cachedRecords.length;
      }
    }


    function toggleRecordSelection(checkbox) {
      const recordId = Number(checkbox.dataset.id);
      if (checkbox.checked) {
        selectedRecordIds.add(recordId);
      } else {
        selectedRecordIds.delete(recordId);
      }
      updateSelectedCount();
    }

    function toggleAllRecords(checkbox) {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      if (checkbox.checked) {
        cachedRecords.forEach(record => selectedRecordIds.add(record.recordId));
        checkboxes.forEach(cb => cb.checked = true);
      } else {
        selectedRecordIds.clear();
        checkboxes.forEach(cb => cb.checked = false);
      }
      updateSelectedCount();
    }

    async function deleteSelectedRecords() {
      if (selectedRecordIds.size === 0) return;
      if (!confirm(`${selectedRecordIds.size}개의 기록을 삭제하시겠습니까?\n관련 사진 파일도 함께 삭제됩니다.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ recordIds: Array.from(selectedRecordIds) })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`✅ ${data.deleted}건 삭제, ${data.deletedFiles}개 파일 제거`);
          await loadRecords();
        } else {
          alert('❌ ' + (data.message || '삭제 실패'));
        }
      } catch (e) {
        alert('삭제 중 오류가 발생했습니다.');
        console.error('선택 삭제 오류:', e);
      }
    }

    async function deleteAllRecords() {
      if (cachedRecords.length === 0) {
        alert('삭제할 기록이 없습니다.');
        return;
      }
      if (!confirm(`총 ${cachedRecords.length}건의 모든 기록을 삭제하시겠습니까?\n관련 사진 파일도 함께 삭제됩니다.`)) return;

      try {
        const res = await fetch('/api/admin/delete-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ deleteAll: true })
        });
        const data = await res.json();

        if (data.ok) {
          alert(`✅ 전체 삭제 완료 (${data.deleted}건, 파일 ${data.deletedFiles}개 제거)`);
          await loadRecords();
        } else {
          alert('❌ ' + (data.message || '전체 삭제 실패'));
        }
      } catch (e) {
        alert('전체 삭제 중 오류가 발생했습니다.');
        console.error('전체 삭제 오류:', e);
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/admin/check', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          cachedRecords = [];
          resetSelectionState();
          setRecordsPlaceholder('조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.');
          loadDeviceRequests();
        } else {
          logout();
        }
      } catch {
        logout();
      }
    }

    async function login() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!password) {
        errorDiv.textContent = '비밀번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        
        if (data.ok) {
          adminToken = data.token;
          localStorage.setItem('admin_token', adminToken);
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          errorDiv.classList.add('hidden');
          cachedRecords = [];
          resetSelectionState();
          setRecordsPlaceholder('조회 조건을 선택한 뒤 조회 버튼을 눌러주세요.');
          loadDeviceRequests();
        } else {
          errorDiv.textContent = data.message || '로그인 실패';
          errorDiv.classList.remove('hidden');
        }
      } catch (e) {
        errorDiv.textContent = '로그인 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    function logout() {
      localStorage.removeItem('admin_token');
      adminToken = null;
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
    }

    async function loadRecords() {
      const empInput = document.getElementById('searchEmpId');
      const dateInput = document.getElementById('dateFilter');
      const monthInput = document.getElementById('monthFilter');
      const empId = empInput ? empInput.value.trim() : '';
      const dateValue = dateInput ? dateInput.value : '';
      const monthValue = monthInput ? monthInput.value : '';

      if (dateValue && monthValue) {
        alert('날짜와 월은 동시에 선택할 수 없습니다.');
        return;
      }

      if (!empId && !dateValue && !monthValue) {
        alert('사번 또는 날짜/월을 선택해주세요.');
        return;
      }

      const params = new URLSearchParams();
      if (empId) params.set('employeeId', empId);
      if (dateValue) params.set('date', dateValue);
      if (monthValue) params.set('month', monthValue);
      const queryString = params.toString();
      const url = `/api/admin/records${queryString ? `?${queryString}` : ''}`;
      setRecordsPlaceholder('기록을 불러오는 중입니다...');
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          cachedRecords = data.records || [];
          displayRecords(cachedRecords);
        } else {
          cachedRecords = [];
          setRecordsPlaceholder(data.message ? `기록 조회 실패: ${data.message}` : '기록 조회에 실패했습니다.');
        }
      } catch (e) {
        cachedRecords = [];
        setRecordsPlaceholder('기록 조회 중 오류가 발생했습니다.');
      } finally {
        resetSelectionState();
      }
    }

    function displayRecords(records) {
      const tableDiv = document.getElementById('recordsTable');
      tableDiv.className = 'records-table';
      if (!records || records.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">등록 기록이 없습니다.</p>';
        updateSelectedCount();
        return;
      }

      // 시간 포맷팅 함수
      const formatTime = (timeStr, shortFormat = false) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          const pad = (n) => String(n).padStart(2, '0');
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          if (shortFormat) {
            return `${month}/${day}`;
          }
          const hour = pad(date.getHours());
          const minute = pad(date.getMinutes());
          const second = pad(date.getSeconds());
          return `${year}/${month}/${day} ${hour}:${minute}:${second}`;
        } catch {
          return timeStr;
        }
      };

      const formatSize = (bytes) => {
        if (!bytes) return '-';
        const units = ['B', 'KB', 'MB', 'GB'];
        let value = Number(bytes);
        let unitIndex = 0;
        while (value >= 1024 && unitIndex < units.length - 1) {
          value /= 1024;
          unitIndex += 1;
        }
        return `${value % 1 === 0 ? value : value.toFixed(1)} ${units[unitIndex]}`;
      };

      let html = '<table><thead><tr><th style="width: 42px;">선택</th><th>시간</th><th>사번</th><th>이름</th><th>사진</th><th>상태 / 작업</th></tr></thead><tbody>';
      records.forEach(record => {
        const imageUrl = record.file || '';
        const hasImage = Boolean(imageUrl);
        const sizeLabel = record.photo_size ? formatSize(record.photo_size) : '-';
        const resolutionLabel = record.photo_width && record.photo_height
          ? `${record.photo_width}×${record.photo_height}`
          : '-';
        const cleanupTime = record.photo_deleted_at
          ? '사진 삭제됨'
          : record.cleanup_scheduled_at
            ? `삭제 예정 ${formatTime(record.cleanup_scheduled_at, true)}`
            : '보관 중';
        const statusBadge = record.photo_deleted_at
          ? '<span class="status-badge status-rejected">삭제됨</span>'
          : '';
        html += `<tr>
          <td class="select-cell">
            <input type="checkbox" class="record-checkbox" data-id="${record.recordId}" onchange="toggleRecordSelection(this)" />
          </td>
          <td class="time-cell">${formatTime(record.server_time)}</td>
          <td class="emp-cell"><strong>${record.employee_id || '-'}</strong></td>
          <td class="name-cell">
            <span class="truncate" title="${(record.name || '-').replace(/"/g, '&quot;')}">${record.name || '-'}</span>
          </td>
          <td class="photo-cell">
            ${hasImage ? `
              <div style="display: inline-flex; flex-direction: column; align-items: center; gap: 4px;">
                <img src="${imageUrl}"
                     alt="미리보기"
                     class="photo-preview"
                     onclick="showImageModal('${imageUrl}', '사진 미리보기')" />
                <div class="photo-meta" style="font-size: 0.75em; color: #666;">
                  ${sizeLabel} · ${resolutionLabel}
                </div>
              </div>
            ` : '<span style="color: #999;">-</span>'}
          </td>
          <td class="status-cell">
            <div class="status-wrapper">
              ${statusBadge || ''}
              <span class="status-time">${cleanupTime}</span>
            </div>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
      updateSelectedCount();
    }

    // 이미지 모달 표시 함수
    function showImageModal(imageUrl, fileName) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
      `;
      modal.onclick = () => {
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
      img.onclick = (e) => e.stopPropagation();
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '✕';
      closeBtn.style.cssText = `
        position: absolute; top: 20px; right: 20px;
        width: 40px; height: 40px; border-radius: 50%;
        background: rgba(255,255,255,0.9); border: none;
        font-size: 24px; cursor: pointer; color: #333;
        display: flex; align-items: center; justify-content: center;
      `;
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };
      
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
    }

    async function updateDeviceId() {
      const empId = document.getElementById('updateEmpId').value.trim();
      const newDeviceId = document.getElementById('updateDeviceId').value.trim();
      const resultDiv = document.getElementById('updateResult');
      
      if (!empId || !newDeviceId) {
        resultDiv.innerHTML = '<div class="error">사번과 새 기기 ID를 모두 입력해주세요.</div>';
        resultDiv.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin/update-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ employeeId: empId, deviceId: newDeviceId })
        });
        const data = await res.json();
        
        if (data.ok) {
          resultDiv.innerHTML = `<div class="success">✅ 기기 ID가 성공적으로 업데이트되었습니다. (${data.updated}개 기록 업데이트)</div>`;
          resultDiv.classList.remove('hidden');
          loadRecords(); // 기록 새로고침
        } else {
          resultDiv.innerHTML = `<div class="error">❌ ${data.message || '업데이트 실패'}</div>`;
          resultDiv.classList.remove('hidden');
        }
      } catch (e) {
        resultDiv.innerHTML = '<div class="error">업데이트 중 오류가 발생했습니다.</div>';
        resultDiv.classList.remove('hidden');
      }
    }

    async function downloadCSV() {
      try {
        const res = await fetch('/api/admin/download-csv', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          alert('CSV 다운로드 실패');
        }
      } catch (e) {
        alert('CSV 다운로드 중 오류가 발생했습니다.');
      }
    }

    async function downloadConsentLogs() {
      try {
        const res = await fetch('/api/admin/download-consent-logs', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        if (res.status === 204) {
          alert('저장된 동의 로그가 없습니다.');
          return;
        }
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `consent_logs_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          const data = await res.json().catch(() => ({}));
          alert('동의 로그 다운로드 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (e) {
        alert('동의 로그 다운로드 중 오류가 발생했습니다.');
        console.error('download consent logs error:', e);
      }
    }

    // 기기 재등록 요청 목록 조회
    async function loadDeviceRequests() {
      const status = document.getElementById('requestStatusFilter').value;
      const url = `/api/admin/device-requests?status=${status}`;
      
      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        
        if (data.ok) {
          displayDeviceRequests(data.requests);
        } else {
          alert('요청 목록 조회 실패: ' + (data.message || '알 수 없는 오류'));
        }
      } catch (e) {
        alert('요청 목록 조회 중 오류가 발생했습니다.');
      }
    }

    // 기기 재등록 요청 목록 표시
    function displayDeviceRequests(requests) {
      const tableDiv = document.getElementById('deviceRequestsTable');
      const countSpan = document.getElementById('requestCount');
      
      if (!requests || requests.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">요청이 없습니다.</p>';
        countSpan.textContent = '';
        return;
      }

      // 시간 포맷팅 함수
      const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
          const date = new Date(timeStr);
          return date.toLocaleString('ko-KR', { 
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return timeStr;
        }
      };

      countSpan.textContent = `총 ${requests.length}건`;
      
      let html = '<table><thead><tr><th>요청일시</th><th>사번</th><th>이름</th><th>기기 ID</th><th>상태</th><th>처리일시</th><th>작업</th></tr></thead><tbody>';
      requests.forEach(req => {
        const statusClass = req.status === 'pending' ? 'status-pending' : 
                           req.status === 'approved' ? 'status-approved' : 
                           'status-rejected';
        const statusText = req.status === 'pending' ? '⏳ 대기' : 
                          req.status === 'approved' ? '✅ 승인' : 
                          '❌ 거부';
        const processTime = formatTime(req.approvedAt || req.rejectedAt);
        const actions = req.status === 'pending' ? 
          `<button class="primary" onclick="approveRequest('${req.id}')">승인</button>
           <button class="danger" onclick="rejectRequest('${req.id}')">거부</button>` : 
          '-';
        
        html += `<tr>
          <td>${formatTime(req.requestedAt)}</td>
          <td><strong>${req.employeeId || '-'}</strong></td>
          <td>${req.name || '-'}</td>
          <td style="font-size: 0.85em; word-break: break-all; max-width: 200px;">${req.deviceId || '-'}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${processTime}</td>
          <td>${actions}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    // 요청 승인
    async function approveRequest(requestId) {
      if (!confirm('이 요청을 승인하시겠습니까? 승인하면 해당 사번의 모든 등록 기록의 기기 ID가 업데이트됩니다.')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/approve-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert(`✅ 승인 완료 (${data.updated}개 기록 업데이트)`);
          loadDeviceRequests();
          loadRecords(); // 등록 기록도 새로고침
        } else {
          alert('❌ ' + (data.message || '승인 실패'));
        }
      } catch (e) {
        alert('승인 처리 중 오류가 발생했습니다.');
        console.error('승인 오류:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }

    // 요청 거부
    async function rejectRequest(requestId) {
      if (!confirm('이 요청을 거부하시겠습니까?')) return;
      
      const tableDiv = document.getElementById('deviceRequestsTable');
      tableDiv.classList.add('loading');
      
      try {
        const res = await fetch('/api/admin/reject-device-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ requestId })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('✅ 거부 완료');
          loadDeviceRequests();
        } else {
          alert('❌ ' + (data.message || '거부 실패'));
        }
      } catch (e) {
        alert('거부 처리 중 오류가 발생했습니다.');
        console.error('거부 오류:', e);
      } finally {
        tableDiv.classList.remove('loading');
      }
    }
  </script>
</body>
</html>

